---
# tasks file for awscli

- name: Install dependencies for AWS CLI installation
  ansible.builtin.apt:
    name:
      - unzip
      - curl
      - groff
      - less
    state: present
    update_cache: true
  tags:
    - awscli
    - aws
    - packages
    - cloud
    - dependencies

- name: Check if AWS CLI is already installed
  ansible.builtin.command: aws --version
  register: awscli_installed
  changed_when: false
  failed_when: false
  tags:
    - awscli
    - aws
    - cloud

- name: Display current AWS CLI version if installed
  ansible.builtin.debug:
    msg: "AWS CLI already installed: {{ awscli_installed.stdout }}"
  when: awscli_installed.rc == 0
  tags:
    - awscli
    - aws
    - cloud

- name: Create temporary directory for AWS CLI installation
  ansible.builtin.file:
    path: "{{ awscli_temp_dir }}"
    state: directory
    mode: '0755'
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud

- name: Download AWS CLI v2 installer
  ansible.builtin.get_url:
    url: "{{ awscli_download_url }}"
    dest: "{{ awscli_temp_dir }}/awscliv2.zip"
    mode: '0644'
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud
    - download
  # Note: AWS does not publish SHA checksums for the "latest" version URL.
  # AWS recommends PGP signature verification. Security relies on HTTPS from amazonaws.com.
  # For production environments, consider pinning to specific version with checksum.

- name: Extract AWS CLI installer
  ansible.builtin.unarchive:
    src: "{{ awscli_temp_dir }}/awscliv2.zip"
    dest: "{{ awscli_temp_dir }}"
    remote_src: true
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud

- name: Install AWS CLI v2
  ansible.builtin.command:
    cmd: "{{ awscli_temp_dir }}/aws/install --install-dir {{ awscli_install_dir }}/aws-cli --bin-dir {{ awscli_install_dir }}/bin"
  when: awscli_installed.rc != 0
  register: awscli_install_result
  changed_when: awscli_install_result.rc == 0
  tags:
    - awscli
    - aws
    - cloud

- name: Clean up installation files
  ansible.builtin.file:
    path: "{{ awscli_temp_dir }}"
    state: absent
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud
    - cleanup

- name: Verify AWS CLI installation
  ansible.builtin.command: aws --version
  register: awscli_version
  changed_when: false
  tags:
    - awscli
    - aws
    - cloud

- name: Enable AWS CLI bash completion
  ansible.builtin.lineinfile:
    path: /etc/bash.bashrc
    line: "complete -C '/usr/local/bin/aws_completer' aws"
    create: true
    mode: '0644'
  tags:
    - awscli
    - aws
    - cloud
    - completion

- name: Display AWS CLI installation info
  ansible.builtin.debug:
    msg: |
      AWS CLI v2 has been installed successfully!

      Version: {{ awscli_version.stdout }}

      Useful commands:
      - aws --version              : Show AWS CLI version
      - aws configure              : Configure AWS credentials
      - aws configure list         : Show current configuration
      - aws sts get-caller-identity : Verify credentials
      - aws help                   : Show help
      - aws <service> help         : Service-specific help

      Initial setup:
      1. Configure credentials: aws configure
         - AWS Access Key ID
         - AWS Secret Access Key
         - Default region (e.g., us-east-1)
         - Default output format (json, yaml, text, table)

      2. Or use environment variables:
         export AWS_ACCESS_KEY_ID=your_access_key
         export AWS_SECRET_ACCESS_KEY=your_secret_key
         export AWS_DEFAULT_REGION=us-east-1

      3. Or use AWS SSO: aws configure sso

      Configuration files:
      - ~/.aws/config       : AWS configuration
      - ~/.aws/credentials  : AWS credentials

      Common commands:
      - aws s3 ls                    : List S3 buckets
      - aws ec2 describe-instances   : List EC2 instances
      - aws iam list-users           : List IAM users
      - aws lambda list-functions    : List Lambda functions
      - aws sts assume-role          : Assume IAM role

      Multiple profiles:
      - aws configure --profile work
      - aws s3 ls --profile work
      - export AWS_PROFILE=work

      Output formats:
      - --output json    : JSON format (default)
      - --output yaml    : YAML format
      - --output text    : Text format
      - --output table   : ASCII table format

      Query results:
      - aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,State.Name]'

      Bash completion has been enabled!
      You may need to restart your shell or run: source /etc/bash.bashrc
  tags:
    - awscli
    - aws
    - cloud
