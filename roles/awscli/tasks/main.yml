---
# tasks file for awscli

- name: Install dependencies for AWS CLI installation
  ansible.builtin.apt:
    name:
      - unzip
      - curl
      - groff
      - less
    state: present
    update_cache: true
  tags:
    - awscli
    - aws
    - packages
    - cloud
    - dependencies

- name: Check if AWS CLI is already installed
  ansible.builtin.command: aws --version
  register: awscli_installed
  changed_when: false
  failed_when: false
  tags:
    - awscli
    - aws
    - cloud

- name: Create temporary directory for AWS CLI installation
  ansible.builtin.file:
    path: "{{ awscli_temp_dir }}"
    state: directory
    mode: '0755'
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud

- name: Download AWS CLI v2 installer
  ansible.builtin.get_url:
    url: "{{ awscli_download_url }}"
    dest: "{{ awscli_temp_dir }}/awscliv2.zip"
    mode: '0644'
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud
    - download
  # Note: AWS does not publish SHA checksums for the "latest" version URL.
  # AWS recommends PGP signature verification. Security relies on HTTPS from amazonaws.com.
  # For production environments, consider pinning to specific version with checksum.

- name: Extract AWS CLI installer
  ansible.builtin.unarchive:
    src: "{{ awscli_temp_dir }}/awscliv2.zip"
    dest: "{{ awscli_temp_dir }}"
    remote_src: true
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud

- name: Install AWS CLI v2
  ansible.builtin.command:
    cmd: "{{ awscli_temp_dir }}/aws/install --install-dir {{ awscli_install_dir }}/aws-cli --bin-dir {{ awscli_install_dir }}/bin"
  when: awscli_installed.rc != 0
  register: awscli_install_result
  changed_when: awscli_install_result.rc == 0
  tags:
    - awscli
    - aws
    - cloud

- name: Clean up installation files
  ansible.builtin.file:
    path: "{{ awscli_temp_dir }}"
    state: absent
  when: awscli_installed.rc != 0
  tags:
    - awscli
    - aws
    - cloud
    - cleanup

- name: Verify AWS CLI installation
  ansible.builtin.command: aws --version
  register: awscli_version
  changed_when: false
  tags:
    - awscli
    - aws
    - cloud

- name: Enable AWS CLI bash completion
  ansible.builtin.lineinfile:
    path: /etc/bash.bashrc
    line: "complete -C '/usr/local/bin/aws_completer' aws"
    create: true
    mode: '0644'
  tags:
    - awscli
    - aws
    - cloud
    - completion
