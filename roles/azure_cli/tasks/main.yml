---
# tasks file for azure_cli

- name: Install dependencies for Azure CLI installation
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - apt-transport-https
      - lsb-release
      - gnupg
    state: present
    update_cache: true
  tags:
    - azure_cli
    - azure
    - packages
    - cloud
    - dependencies

- name: Check if Azure CLI is already installed
  ansible.builtin.command: az --version
  register: azure_cli_installed
  changed_when: false
  failed_when: false
  tags:
    - azure_cli
    - azure
    - cloud

- name: Create directory for Microsoft GPG key
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: '0755'
  tags:
    - azure_cli
    - azure
    - cloud

- name: Check if Azure CLI GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ azure_cli_keyring_path }}"
  register: azure_cli_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - azure_cli
    - azure
    - cloud
    - security

- name: Remove corrupted Azure CLI GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ azure_cli_keyring_path }}"
    state: absent
  when: azure_cli_keyring_check.rc != 0
  tags:
    - azure_cli
    - azure
    - cloud
    - security

- name: Download Microsoft GPG key
  ansible.builtin.get_url:
    url: "{{ azure_cli_gpg_key_url }}"
    dest: "{{ azure_cli_temp_keyring }}"
    mode: '0644'
  tags:
    - azure_cli
    - azure
    - cloud
    - download

- name: Convert and install Microsoft GPG key to keyring
  ansible.builtin.command:
    cmd: gpg --dearmor --output {{ azure_cli_keyring_path }} {{ azure_cli_temp_keyring }}
  args:
    creates: "{{ azure_cli_keyring_path }}"
  tags:
    - azure_cli
    - azure
    - cloud

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: "{{ azure_cli_temp_keyring }}"
    state: absent
  tags:
    - azure_cli
    - azure
    - cloud
    - cleanup

- name: Get Ubuntu codename
  ansible.builtin.command: lsb_release -cs
  register: ubuntu_codename
  changed_when: false
  tags:
    - azure_cli
    - azure
    - cloud

- name: Add Microsoft Azure CLI repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by={{ azure_cli_keyring_path }}] {{ azure_cli_repo_url }} {{ ubuntu_codename.stdout }} main"
    filename: azure-cli
    state: present
  tags:
    - azure_cli
    - azure
    - cloud

- name: Install Azure CLI
  ansible.builtin.apt:
    name: azure-cli
    state: present
    update_cache: true
  when: azure_cli_installed.rc != 0
  tags:
    - azure_cli
    - azure
    - cloud
    - packages

- name: Verify Azure CLI installation
  ansible.builtin.command: az --version
  register: azure_cli_version
  changed_when: false
  tags:
    - azure_cli
    - azure
    - cloud

- name: Enable Azure CLI bash completion
  ansible.builtin.lineinfile:
    path: /etc/bash.bashrc
    line: "source /etc/bash_completion.d/azure-cli"
    create: true
    mode: '0644'
  tags:
    - azure_cli
    - azure
    - cloud
    - completion