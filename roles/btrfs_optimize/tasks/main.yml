---
# tasks file for btrfs_optimize

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ btrfs_fstab_backup_dir }}"
    state: directory
    mode: '0700'
    owner: root
    group: root
  when: btrfs_create_backup
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
    - backup

- name: Create timestamped backup of fstab
  ansible.builtin.copy:
    src: /etc/fstab
    dest: "{{ btrfs_fstab_backup_dir }}/fstab.{{ ansible_facts['date_time']['iso8601_basic_short'] }}"
    remote_src: true
    mode: '0600'
    owner: root
    group: root
  when:
    - btrfs_create_backup
    - not ansible_check_mode
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
    - backup

- name: Check for /boot and /boot/efi mount ordering issues
  ansible.builtin.shell: |
    set -o pipefail
    # Check if both /boot and /boot/efi exist in fstab
    if grep -qE '^\s*[^#].*\s+/boot\s+' /etc/fstab && grep -qE '^\s*[^#].*\s+/boot/efi\s+' /etc/fstab; then
      # Get line numbers for /boot and /boot/efi
      boot_line=$(grep -nE '^\s*[^#].*\s+/boot\s+' /etc/fstab | head -1 | cut -d: -f1)
      boot_efi_line=$(grep -nE '^\s*[^#].*\s+/boot/efi\s+' /etc/fstab | head -1 | cut -d: -f1)

      # If /boot/efi comes before /boot, we have an ordering issue
      if [ "$boot_efi_line" -lt "$boot_line" ]; then
        echo "ORDER_ISSUE"
      else
        echo "ORDER_OK"
      fi
    else
      echo "NOT_BOTH_PRESENT"
    fi
  args:
    executable: /bin/bash
  register: fstab_boot_order
  changed_when: false
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
    - fstab_order

- name: Fix /boot and /boot/efi ordering in fstab
  ansible.builtin.shell: |
    set -o pipefail
    # Extract the /boot and /boot/efi lines
    boot_line=$(grep -E '^\s*[^#].*\s+/boot\s+' /etc/fstab | head -1)
    boot_efi_line=$(grep -E '^\s*[^#].*\s+/boot/efi\s+' /etc/fstab | head -1)

    # Create a temp file with corrected order
    # Remove both lines, then add them back in correct order
    grep -vE '^\s*[^#].*\s+/boot(/efi)?\s+' /etc/fstab > /tmp/fstab.reordered

    # Insert /boot before /boot/efi in the appropriate location
    # Find a good insertion point (after root mount, before other mounts if possible)
    if grep -qE '^\s*[^#].*\s+/\s+' /tmp/fstab.reordered; then
      # Insert after root mount
      awk -v boot="$boot_line" -v boot_efi="$boot_efi_line" '
        /^[^#].*[[:space:]]+\/[[:space:]]+/ { print; print boot; print boot_efi; inserted=1; next }
        !inserted && /^[^#].*[[:space:]]+\/home[[:space:]]+/ { print boot; print boot_efi; inserted=1 }
        { print }
        END { if (!inserted) { print boot; print boot_efi } }
      ' /tmp/fstab.reordered > /tmp/fstab.final
    else
      # Just append at the end
      echo "$boot_line" >> /tmp/fstab.reordered
      echo "$boot_efi_line" >> /tmp/fstab.reordered
      mv /tmp/fstab.reordered /tmp/fstab.final
    fi

    # Validate the new fstab
    if findmnt --verify --tab-file /tmp/fstab.final >/dev/null 2>&1 || \
       findmnt --verify --tab-file /tmp/fstab.final 2>&1 | grep -v "wrong order.*boot"; then
      # If validation passes or only boot order warnings remain, apply the changes
      cp /tmp/fstab.final /etc/fstab
      echo "REORDERED"
    else
      echo "VALIDATION_FAILED"
      exit 1
    fi

    rm -f /tmp/fstab.reordered /tmp/fstab.final
  args:
    executable: /bin/bash
  when: fstab_boot_order.stdout == "ORDER_ISSUE"
  register: fstab_reorder_result
  changed_when: fstab_reorder_result.stdout == "REORDERED"
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
    - fstab_order

- name: Check current fstab for BTRFS entries
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^\s*UUID=.*\s+btrfs\s+' /etc/fstab || true
  args:
    executable: /bin/bash
  register: current_btrfs_entries
  changed_when: false
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem

- name: Optimize BTRFS mount options for root subvolume
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^(UUID=[a-f0-9-]+)\s+/\s+btrfs\s+.*subvol=/@[^\s,]*(.*)(\s+\d+\s+\d+)\s*$'
    backrefs: true
    line: '\1\t/\tbtrfs\tsubvol=/@,{{ btrfs_mount_options }}\3'
    backup: false
    validate: '/usr/bin/findmnt --verify --tab-file %s'
  register: root_fstab_modified
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
    - root

- name: Optimize BTRFS mount options for home subvolume
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^(UUID=[a-f0-9-]+)\s+/home\s+btrfs\s+.*subvol=/@home[^\s,]*(.*)(\s+\d+\s+\d+)\s*$'
    backrefs: true
    line: '\1\t/home\tbtrfs\tsubvol=/@home,{{ btrfs_mount_options }}\3'
    backup: false
    validate: '/usr/bin/findmnt --verify --tab-file %s'
  register: home_fstab_modified
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
    - home

- name: Verify fstab syntax after modifications
  ansible.builtin.command: findmnt --verify --tab-file /etc/fstab
  register: fstab_verify
  changed_when: false
  failed_when: fstab_verify.rc != 0
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
    - verification

- name: Ensure Docker data directory exists
  ansible.builtin.file:
    path: /var/lib/docker
    state: directory
    mode: '0711'
    owner: root
    group: root
  tags:
    - btrfs
    - btrfs_optimize
    - docker
    - filesystem
    - nocow

- name: Check if Docker directory already has nocow attribute
  ansible.builtin.shell: |
    set -o pipefail
    lsattr -d /var/lib/docker | awk '{print $1}' | grep -q 'C' && echo "HAS_NOCOW" || echo "NO_NOCOW"
  args:
    executable: /bin/bash
  register: docker_nocow_check
  changed_when: false
  tags:
    - btrfs
    - btrfs_optimize
    - docker
    - filesystem
    - nocow

- name: Disable copy-on-write for Docker data directory
  ansible.builtin.command: chattr +C /var/lib/docker
  when: docker_nocow_check.stdout == "NO_NOCOW"
  register: docker_nocow_set
  changed_when: docker_nocow_check.stdout == "NO_NOCOW"
  tags:
    - btrfs
    - btrfs_optimize
    - docker
    - filesystem
    - nocow

- name: Read updated fstab BTRFS entries
  ansible.builtin.shell: |
    set -o pipefail
    grep -E '^\s*UUID=.*\s+btrfs\s+' /etc/fstab
  args:
    executable: /bin/bash
  register: updated_btrfs_entries
  changed_when: false
  when: root_fstab_modified.changed or home_fstab_modified.changed
  tags:
    - btrfs
    - btrfs_optimize
    - filesystem
