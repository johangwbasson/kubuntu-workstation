---
- name: Install clamav
  ansible.builtin.package:
    name:
      - clamav
      - clamav-daemon
    state: present
  tags:
    - clamav
    - packages

- name: Ensure ClamAV log directory exists with correct permissions
  ansible.builtin.file:
    path: /var/log/clamav
    state: directory
    owner: clamav
    group: clamav
    mode: '0755'
  tags:
    - clamav
    - logs
    - security

- name: Ensure ClamAV log files exist with correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: touch
    owner: clamav
    group: clamav
    mode: '0664'
    modification_time: preserve
    access_time: preserve
  loop:
    - /var/log/clamav/freshclam.log
    - /var/log/clamav/clamav.log
    - /var/log/clamav/clamonacc.log
  tags:
    - clamav
    - logs
    - security

- name: Configure clamav daemon
  ansible.builtin.template:
    src: clamd.conf.j2
    dest: /etc/clamav/clamd.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart clamav-daemon
  tags:
    - clamav
    - configuration

- name: Create a global quarantine directory
  ansible.builtin.file:
    path: "{{ clamav_quarantine_dir }}"
    state: directory
    owner: clamav
    group: clamav
    mode: '0755'
  tags:
    - clamav
    - security

- name: Deploy ClamAV health check script
  ansible.builtin.template:
    src: clamav-verify.sh.j2
    dest: /usr/local/bin/clamav-verify.sh
    owner: root
    group: root
    mode: '0755'
  tags:
    - clamav
    - security
    - scripts

# Non-CI tasks (user-specific permissions and services)
- name: Grant clamav traversal access to the user's home directory
  ansible.posix.acl:
    path: "/home/{{ username }}"
    entity: clamav
    etype: group
    permissions: x
    state: present
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - security
    - acl

- name: Grant clamav rwx access to the user's downloads directory
  ansible.posix.acl:
    path: "/home/{{ username }}/Downloads"
    entity: clamav
    etype: group
    permissions: rwx
    state: present
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - security
    - acl

- name: Grant clamav access to delete (quarantine) files in the downloads directory
  ansible.posix.acl:
    path: "/home/{{ username }}/Downloads/"
    entity: clamav
    etype: group
    recursive: true
    permissions: rwx
    state: present
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - security
    - acl

- name: Add user to clamav group for freshclam access
  ansible.builtin.user:
    name: "{{ username }}"
    groups: clamav
    append: true
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - users
    - security

- name: Ensure clamav-daemon is running and enabled
  ansible.builtin.service:
    name: clamav-daemon
    state: started
    enabled: true
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - services

- name: Ensure freshclam update service is running and enabled
  ansible.builtin.service:
    name: clamav-freshclam
    state: started
    enabled: true
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - services

- name: Install systemd service for clamonacc
  ansible.builtin.template:
    src: clamonacc.service.j2
    dest: /etc/systemd/system/clamonacc.service
    mode: '0644'
  notify: Reload systemd and restart clamonacc
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - services

- name: Ensure clamonacc service is running and enabled
  ansible.builtin.service:
    name: clamonacc
    state: started
    enabled: true
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
    - services

- name: Display ClamAV installation and usage info
  ansible.builtin.debug:
    msg: |
      ClamAV has been installed and configured successfully!

      Services running:
      - clamav-daemon: Antivirus scanning engine
      - clamav-freshclam: Automatic virus definition updates (runs in background)
      - clamonacc: On-access scanning for Downloads directory

      Virus definitions are updated automatically every hour.

      IMPORTANT - About freshclam:
      ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      The freshclam daemon is running automatically in the background.
      You do NOT need to run 'freshclam' manually.

      If you see "Failed to lock log file" error when running freshclam,
      this is NORMAL - it means automatic updates are already running.

      To check update status:
        systemctl status clamav-freshclam
        sudo tail -f /var/log/clamav/freshclam.log

      To force manual update (if needed):
        sudo systemctl stop clamav-freshclam
        sudo freshclam
        sudo systemctl start clamav-freshclam

      Or simply:
        sudo freshclam
      ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

      Useful commands:
      - clamscan <file/dir>       : Scan files or directories
      - clamscan -r ~             : Scan home directory recursively
      - clamscan -i -r ~/Downloads: Scan Downloads (infected files only)
      - clamdscan <file>          : Fast scan using daemon
      - systemctl status clamav-daemon : Check antivirus service
      - systemctl status clamonacc    : Check on-access scanning

      Configuration:
      - Daemon config: /etc/clamav/clamd.conf
      - Update config: /etc/clamav/freshclam.conf
      - Virus DB: /var/lib/clamav/
      - Logs: /var/log/clamav/
      - Quarantine: {{ clamav_quarantine_dir }}

      On-access scanning:
      - Monitors: /home/{{ username }}/Downloads
      - Infected files are automatically quarantined
      - Check logs: sudo tail -f /var/log/clamav/clamonacc.log

      Testing:
      - Download EICAR test file: wget https://secure.eicar.org/eicar.com.txt
      - Should be detected and quarantined automatically
      - Or scan manually: clamscan eicar.com.txt

      Health check:
      - Run: sudo /usr/local/bin/clamav-verify.sh
      - Verifies all ClamAV services are running

      Performance note:
      - First scan may be slow (building cache)
      - Subsequent scans are much faster
      - ClamAV uses ~200MB RAM when idle

      Your user has been added to the 'clamav' group for better integration.
      Log out and back in for group membership to take effect.
  when: lookup('env', 'CI') != 'true'
  tags:
    - clamav
