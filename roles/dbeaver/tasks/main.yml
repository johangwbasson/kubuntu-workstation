---
# tasks file for dbeaver

- name: Check if DBeaver GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ dbeaver_gpg_keyring_path }}"
  register: dbeaver_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Remove corrupted DBeaver GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ dbeaver_gpg_keyring_path }}"
    state: absent
  when: dbeaver_keyring_check.rc != 0
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Download DBeaver GPG key
  ansible.builtin.get_url:
    url: "{{ dbeaver_gpg_key_url }}"
    dest: /tmp/dbeaver-gpg-key.asc
    mode: '0644'
  when: dbeaver_keyring_check.rc != 0
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Convert and install DBeaver GPG key to keyring
  ansible.builtin.command:
    cmd: gpg --dearmor --output "{{ dbeaver_gpg_keyring_path }}" /tmp/dbeaver-gpg-key.asc
    creates: "{{ dbeaver_gpg_keyring_path }}"
  when: dbeaver_keyring_check.rc != 0
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Set proper permissions on DBeaver keyring
  ansible.builtin.file:
    path: "{{ dbeaver_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/dbeaver-gpg-key.asc
    state: absent
  when: dbeaver_keyring_check.rc != 0
  tags:
    - dbeaver
    - database
    - packages
    - cleanup

- name: Add DBeaver repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ dbeaver_gpg_keyring_path }}] {{ dbeaver_repo_url }} /"
    state: present
    filename: dbeaver
    update_cache: true
  tags:
    - dbeaver
    - database
    - packages

- name: Install DBeaver Community Edition
  ansible.builtin.apt:
    name: "{{ dbeaver_package_name }}"
    state: "{{ dbeaver_package_state }}"
    update_cache: true
  tags:
    - dbeaver
    - database
    - packages

- name: Display DBeaver installation info
  ansible.builtin.debug:
    msg: |
      DBeaver Community Edition has been installed successfully!

      Installation details:
      - Package: {{ dbeaver_package_name }}
      - Binary location: /usr/bin/dbeaver
      - Managed by apt package manager
      - Desktop entry: /usr/share/applications/dbeaver-ce.desktop

      Features:
      - Universal database tool (free and open source)
      - Support for 80+ databases:
        * PostgreSQL, MySQL, MariaDB
        * Oracle, SQL Server, DB2
        * SQLite, H2, Derby
        * MongoDB, Cassandra, Redis
        * And many more...
      - SQL editor with syntax highlighting
      - Data viewer and editor
      - ER diagrams
      - Database migration tools
      - Import/Export data
      - Query execution plans

      Getting started:
      1. Launch from application menu: Search for "DBeaver"
      2. Or run from terminal: dbeaver
      3. Create new database connection
      4. Select database type (PostgreSQL, MySQL, etc.)
      5. Enter connection details

      Common database drivers:
      - PostgreSQL: Pre-installed
      - MySQL: Pre-installed
      - SQLite: Pre-installed
      - Others: Will download automatically on first connection

      Useful keyboard shortcuts:
      - Ctrl+Enter       : Execute SQL statement
      - Ctrl+\           : Execute SQL script
      - Ctrl+Shift+E     : Execute SQL statement
      - Ctrl+Shift+F     : Format SQL
      - Ctrl+Space       : SQL auto-completion
      - F4               : Edit object
      - Ctrl+]           : Navigate to object

      Tips for Java/Kotlin developers:
      - Connect to local PostgreSQL/MySQL for development
      - Use ER diagrams to visualize database schema
      - Export database schema as SQL scripts
      - Import/export test data
      - View query execution plans for optimization

      Docker database containers:
      - PostgreSQL: docker run -d -p 5432:5432 -e POSTGRES_PASSWORD=password postgres
      - MySQL: docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password mysql
      - Then connect from DBeaver using localhost and the port

      Documentation: https://dbeaver.io/docs/
      Community: https://github.com/dbeaver/dbeaver
  tags:
    - dbeaver
    - database
