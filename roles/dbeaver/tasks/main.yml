---
# tasks file for dbeaver

- name: Check if DBeaver GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ dbeaver_gpg_keyring_path }}"
  register: dbeaver_keyring_check
  changed_when: false
  failed_when: false
  when: not ansible_check_mode
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Remove corrupted DBeaver GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ dbeaver_gpg_keyring_path }}"
    state: absent
  when:
    - dbeaver_keyring_check.rc is defined
    - dbeaver_keyring_check.rc != 0
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Download DBeaver GPG key
  ansible.builtin.get_url:
    url: "{{ dbeaver_gpg_key_url }}"
    dest: /tmp/dbeaver-gpg-key.asc
    mode: '0644'
  when:
    - dbeaver_keyring_check.rc is defined
    - dbeaver_keyring_check.rc != 0
    - not ansible_check_mode
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Convert and install DBeaver GPG key to keyring
  ansible.builtin.command:
    cmd: gpg --dearmor --output "{{ dbeaver_gpg_keyring_path }}" /tmp/dbeaver-gpg-key.asc
    creates: "{{ dbeaver_gpg_keyring_path }}"
  when:
    - dbeaver_keyring_check.rc is defined
    - dbeaver_keyring_check.rc != 0
    - not ansible_check_mode
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Set proper permissions on DBeaver keyring
  ansible.builtin.file:
    path: "{{ dbeaver_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  when: not ansible_check_mode
  tags:
    - dbeaver
    - database
    - packages
    - security

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/dbeaver-gpg-key.asc
    state: absent
  when:
    - dbeaver_keyring_check.rc is defined
    - dbeaver_keyring_check.rc != 0
  tags:
    - dbeaver
    - database
    - packages
    - cleanup

- name: Add DBeaver repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ dbeaver_gpg_keyring_path }}] {{ dbeaver_repo_url }} /"
    state: present
    filename: dbeaver
    update_cache: true
  tags:
    - dbeaver
    - database
    - packages

- name: Install DBeaver Community Edition
  ansible.builtin.apt:
    name: "{{ dbeaver_package_name }}"
    state: "{{ dbeaver_package_state }}"
    update_cache: true
  tags:
    - dbeaver
    - database
    - packages
