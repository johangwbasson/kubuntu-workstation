---
# tasks file for firefox

- name: Check if Firefox package is installed
  ansible.builtin.shell: |
    set -o pipefail
    dpkg -l firefox 2>/dev/null | grep -q '^ii' && echo "installed" || echo "not_installed"
  args:
    executable: /bin/bash
  register: firefox_check
  changed_when: false
  failed_when: false
  tags:
    - packages
    - firefox
    - browser

- name: Check if installed Firefox is snap-based
  ansible.builtin.shell: |
    set -o pipefail
    apt-cache policy firefox | grep -q 'Installed.*ubuntu' && echo "snap_based" || echo "not_snap"
  args:
    executable: /bin/bash
  register: firefox_snap_check
  changed_when: false
  failed_when: false
  when: firefox_check.stdout == "installed"
  tags:
    - packages
    - firefox
    - browser

- name: Remove snap-based Firefox package if present
  ansible.builtin.apt:
    name: firefox
    state: absent
    purge: true
  when:
    - firefox_check.stdout == "installed"
    - firefox_snap_check.stdout == "snap_based"
  tags:
    - packages
    - firefox
    - browser

- name: Create APT preference to prioritize Mozilla PPA over Ubuntu repo
  ansible.builtin.copy:
    dest: /etc/apt/preferences.d/mozilla-firefox
    content: |
      # Prioritize Firefox from Mozilla PPA over Ubuntu's snap-based package
      Package: firefox*
      Pin: release o=LP-PPA-mozillateam
      Pin-Priority: 1001

      # Block Firefox from Ubuntu repo (which requires snapd)
      Package: firefox*
      Pin: release o=Ubuntu*
      Pin-Priority: -1
    mode: '0644'
    owner: root
    group: root
  tags:
    - packages
    - firefox
    - browser
    - apt-preferences

- name: Check if Mozilla Team GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ firefox_ppa_keyring_path }}"
  register: firefox_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - packages
    - firefox
    - browser
    - security

- name: Remove corrupted Mozilla Team GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ firefox_ppa_keyring_path }}"
    state: absent
  when: firefox_keyring_check.rc != 0
  tags:
    - packages
    - firefox
    - browser
    - security

- name: Download Mozilla Team PPA GPG key
  ansible.builtin.get_url:
    url: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x0AB215679C571D1C8325275B9BDB3D89CE49EC21
    dest: /tmp/mozilla-ppa-key.asc
    mode: '0644'
  tags:
    - packages
    - firefox
    - browser
    - security

- name: Convert and install Mozilla Team GPG key to keyring
  ansible.builtin.command:
    cmd: gpg --dearmor --output "{{ firefox_ppa_keyring_path }}" /tmp/mozilla-ppa-key.asc
    creates: "{{ firefox_ppa_keyring_path }}"
  tags:
    - packages
    - firefox
    - browser
    - security

- name: Set correct permissions on Mozilla Team GPG keyring
  ansible.builtin.file:
    path: "{{ firefox_ppa_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  tags:
    - packages
    - firefox
    - browser
    - security

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/mozilla-ppa-key.asc
    state: absent
  tags:
    - packages
    - firefox
    - browser
    - cleanup

- name: Add Mozilla Team PPA with signed-by
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ firefox_ppa_keyring_path }}] http://ppa.launchpad.net/mozillateam/ppa/ubuntu {{ ansible_distribution_release }} main"
    filename: mozillateam-ppa
    state: present
    update_cache: true
  tags:
    - packages
    - firefox
    - browser

- name: Install Firefox from Mozilla PPA
  ansible.builtin.apt:
    name: firefox
    state: "{{ firefox_package_state }}"
    update_cache: true
  tags:
    - packages
    - firefox
    - browser

- name: Ensure Firefox policies directory exists
  ansible.builtin.file:
    path: /etc/firefox/policies
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - firefox
    - configuration
    - extensions

- name: Configure Firefox policies (browser extensions)
  ansible.builtin.copy:
    src: policies.json
    dest: /etc/firefox/policies/policies.json
    owner: root
    group: root
    mode: '0644'
  tags:
    - firefox
    - configuration
    - extensions
