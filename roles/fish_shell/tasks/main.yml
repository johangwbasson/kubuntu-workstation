---
# tasks file for fish_shell

- name: Check if Fish shell GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ fish_keyring_path }}"
  register: fish_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - fish
    - shell
    - packages
    - security

- name: Remove corrupted Fish shell GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ fish_keyring_path }}"
    state: absent
  when: fish_keyring_check.rc != 0
  tags:
    - fish
    - shell
    - packages
    - security

- name: Download Fish shell PPA GPG key
  ansible.builtin.shell: |
    gpg --no-default-keyring --keyring "{{ fish_keyring_path }}" --keyserver keyserver.ubuntu.com --recv-keys 59FDA1CE1B84B3FAD89366C027557F056DC33CA5
  args:
    creates: "{{ fish_keyring_path }}"
  when: not ansible_check_mode
  tags:
    - fish
    - shell
    - packages
    - security

- name: Set correct permissions on Fish shell GPG keyring
  ansible.builtin.file:
    path: "{{ fish_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  when: not ansible_check_mode
  tags:
    - fish
    - shell
    - packages
    - security

- name: Add Fish shell PPA with signed-by
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ fish_keyring_path }}] http://ppa.launchpad.net/fish-shell/release-3/ubuntu {{ ansible_distribution_release }} main"
    filename: fish-shell-release-3
    state: present
    update_cache: true
  tags:
    - fish
    - shell
    - packages

- name: Install Fish shell
  ansible.builtin.apt:
    name: fish
    state: "{{ fish_package_state }}"
    update_cache: true
  tags:
    - fish
    - shell
    - packages

- name: Set Fish as default shell for user
  ansible.builtin.user:
    name: "{{ fish_user }}"
    shell: /usr/bin/fish
  tags:
    - fish
    - shell
    - configuration

- name: Install dependencies for nvm and sdkman
  ansible.builtin.apt:
    name:
      - curl
      - unzip
      - zip
    state: present
  tags:
    - fish
    - shell
    - dependencies

- name: Ensure Fish config directory exists
  ansible.builtin.file:
    path: "{{ fish_user_home }}/.config/fish"
    state: directory
    owner: "{{ fish_user }}"
    group: "{{ fish_user }}"
    mode: '0755'
  tags:
    - fish
    - shell
    - configuration

- name: Ensure Fish functions directory exists
  ansible.builtin.file:
    path: "{{ fish_user_home }}/.config/fish/functions"
    state: directory
    owner: "{{ fish_user }}"
    group: "{{ fish_user }}"
    mode: '0755'
  tags:
    - fish
    - shell
    - configuration

- name: Check if Fisher is already installed
  ansible.builtin.stat:
    path: "{{ fish_user_home }}/.config/fish/functions/fisher.fish"
  register: fisher_installed
  tags:
    - fish
    - shell
    - fisher

- name: Download and install Fisher
  ansible.builtin.get_url:
    url: "{{ fisher_install_url }}"
    dest: "{{ fish_user_home }}/.config/fish/functions/fisher.fish"
    owner: "{{ fish_user }}"
    group: "{{ fish_user }}"
    mode: '0644'
    force: true
  when: not fisher_installed.stat.exists
  tags:
    - fish
    - shell
    - fisher
  # Note: GitHub raw content does not provide checksums. Security relies on HTTPS.
  # Fisher is a single-file shell script that can be audited in the GitHub repository.

- name: Install Fisher plugins
  become: true
  become_user: "{{ fish_user }}"
  ansible.builtin.shell: |
    fish -c "fisher install {{ item }}"
  args:
    executable: /usr/bin/fish
  loop: "{{ fisher_plugins }}"
  register: fisher_plugin_install
  changed_when: "'Installing' in fisher_plugin_install.stdout or 'Installed' in fisher_plugin_install.stdout"
  failed_when: false
  tags:
    - fish
    - shell
    - fisher
    - plugins

- name: Check if Tide is already configured
  ansible.builtin.stat:
    path: "{{ fish_user_home }}/.config/fish/conf.d/tide.fish"
  register: tide_configured
  tags:
    - fish
    - shell
    - tide
    - prompt

- name: Configure Tide prompt (lean style)
  become: true
  become_user: "{{ fish_user }}"
  ansible.builtin.shell: |
    fish -c "tide configure --auto --style=Lean --prompt_colors='True color' --show_time='12-hour format' --lean_prompt_height='Two lines' --prompt_connection=Disconnected --prompt_spacing=Sparse --icons='Many icons' --transient=No"
  args:
    executable: /usr/bin/fish
  when: not tide_configured.stat.exists
  register: tide_config
  changed_when: tide_config.rc == 0
  failed_when: false
  tags:
    - fish
    - shell
    - tide
    - prompt

- name: Download SDKMAN installer
  ansible.builtin.get_url:
    url: "https://get.sdkman.io?rcupdate=false"
    dest: /tmp/sdkman-install.sh
    mode: '0755'
    force: true
  tags:
    - fish
    - shell
    - sdkman
    - development

- name: Install SDKMAN
  become: true
  become_user: "{{ fish_user }}"
  ansible.builtin.command:
    cmd: bash /tmp/sdkman-install.sh
    creates: "{{ fish_user_home }}/.sdkman"
  environment:
    HOME: "{{ fish_user_home }}"
  tags:
    - fish
    - shell
    - sdkman
    - development

- name: Check if Node.js is already installed via nvm
  become: true
  become_user: "{{ fish_user }}"
  ansible.builtin.shell: |
    fish -c "nvm list"
  args:
    executable: /usr/bin/fish
  register: nvm_list
  changed_when: false
  failed_when: false
  tags:
    - fish
    - shell
    - nvm
    - nodejs

- name: Install Node.js LTS via nvm
  become: true
  become_user: "{{ fish_user }}"
  ansible.builtin.shell: |
    fish -c "nvm install {{ node_version }}"
  args:
    executable: /usr/bin/fish
  when: nvm_list.stdout == "" or "No installed" in nvm_list.stdout
  register: node_install
  changed_when: "'installed' in node_install.stdout or 'Downloading' in node_install.stdout"
  notify: Set Node.js LTS as default
  tags:
    - fish
    - shell
    - nvm
    - nodejs

- name: Add aliases to fish config
  ansible.builtin.lineinfile:
    path: /home/{{ username }}/.config/fish/config.fish
    line: "{{ item }}"
    state: present
    create: true
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'
  loop:
    - "direnv hook fish | source"
    - ""
    - "# LS Aliases"
    - "alias ls='lsd'"
    - "alias l='ls -lha'"
    - "alias la='ls -lhA'"
    - "alias ll='ls -lAFh'"
    - "alias lla='lsd -la'"
    - "alias lsa='ls -lha'"
    - "alias lt='lsd --tree'"
    - ""
    - "# General Aliases"
    - "alias c=clear"
    - ""
    - "# Build Aliases"
    - "alias mcb='mvn clean build'"
    - "alias gcb='./gradlew clean build'"
    - "alias m='make'"
    - ""
    - "# System Aliases"
    - "alias tg='topgrade'"
    - "alias dcu='docker-compose up'"
    - ""
    - "# Git Aliases"
    - "alias gc='git commit'"
    - "alias gs='git status'"
    - "alias gp='git push'"
    - "alias gl='git pull'"
    - "alias gco='git checkout'"
    - "alias gd='git diff'"
    - "alias gb='git branch'"
    - "alias ga='git add'"
    - "alias glo='git log --oneline --decorate --color'"
    - ""
    - "# NPM Aliases"
    - "alias ni='npm install'"
    - "alias nid='npm install --save-dev'"
    - "alias nig='npm install -g'"
    - "alias nr='npm run'"
    - "alias ns='npm start'"
    - "alias nt='npm test'"
    - "alias nb='npm run build'"
    - "alias spot='./gradlew spotlessApply'"
    - ""
    - "# Utility Aliases"
    - "alias lad=lazydocker"
  become: true
  become_user: "{{ username }}"
  tags:
    - fish
    - shell
    - configuration
    - aliases
