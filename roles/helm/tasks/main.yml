---
# tasks file for helm

- name: Install dependencies for Helm
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - gnupg
    state: present
    update_cache: true
  tags:
    - helm
    - kubernetes
    - packages
    - dependencies

- name: Check if Helm GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ helm_gpg_keyring_path }}"
  register: helm_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - helm
    - kubernetes
    - packages
    - security

- name: Remove corrupted Helm GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ helm_gpg_keyring_path }}"
    state: absent
  when: helm_keyring_check.rc != 0
  tags:
    - helm
    - kubernetes
    - packages
    - security

- name: Download Helm GPG key
  ansible.builtin.get_url:
    url: "{{ helm_gpg_key_url }}"
    dest: /tmp/helm-gpg-key.asc
    mode: '0644'
  tags:
    - helm
    - kubernetes
    - packages
    - security

- name: Convert and install Helm GPG key to keyring
  ansible.builtin.command:
    cmd: gpg --dearmor --output "{{ helm_gpg_keyring_path }}" /tmp/helm-gpg-key.asc
    creates: "{{ helm_gpg_keyring_path }}"
  tags:
    - helm
    - kubernetes
    - packages
    - security

- name: Set proper permissions on Helm keyring
  ansible.builtin.file:
    path: "{{ helm_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  tags:
    - helm
    - kubernetes
    - packages
    - security

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/helm-gpg-key.asc
    state: absent
  tags:
    - helm
    - kubernetes
    - packages
    - cleanup

- name: Add Helm repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by={{ helm_gpg_keyring_path }}] {{ helm_repo_url }} all main"
    state: present
    filename: helm-stable-debian
    update_cache: true
  tags:
    - helm
    - kubernetes
    - packages

- name: Install Helm
  ansible.builtin.apt:
    name: "{{ helm_package_name }}"
    state: "{{ helm_package_state }}"
    update_cache: true
  tags:
    - helm
    - kubernetes
    - packages

- name: Get Helm version
  ansible.builtin.command: helm version --short
  register: helm_version_output
  changed_when: false
  tags:
    - helm
    - kubernetes

- name: Display Helm installation info
  ansible.builtin.debug:
    msg: |
      Helm - Kubernetes Package Manager has been installed successfully!

      Installation details:
      - Binary location: /usr/bin/helm
      - Version: {{ helm_version_output.stdout | default('N/A') }}
      - Managed by apt package manager
      - Repository: {{ helm_repo_url }}

      Features:
      - Kubernetes package manager (like apt/yum for K8s)
      - Deploy complex applications with a single command
      - Manage application lifecycle (install, upgrade, rollback)
      - Template engine for Kubernetes manifests
      - Chart repositories (like npm/maven for K8s)
      - Dependency management
      - Release versioning and history

      Prerequisites:
      - kubectl must be installed (already installed via kubectl role)
      - Valid kubeconfig file (~/.kube/config)
      - Access to a Kubernetes cluster

      Getting started:

      1. Add official chart repository:
         helm repo add stable https://charts.helm.sh/stable
         helm repo add bitnami https://charts.bitnami.com/bitnami
         helm repo update

      2. Search for charts:
         helm search repo nginx
         helm search hub wordpress

      3. Install a chart:
         helm install my-nginx bitnami/nginx

      4. List releases:
         helm list

      Common commands:

      Repository management:
      - helm repo add <name> <url>     : Add a chart repository
      - helm repo update               : Update repository indexes
      - helm repo list                 : List configured repositories
      - helm search repo <keyword>     : Search charts in repos

      Chart installation:
      - helm install <name> <chart>           : Install a chart
      - helm install <name> <chart> -f values.yaml  : Install with custom values
      - helm install --dry-run --debug <name> <chart> : Test installation
      - helm install --create-namespace -n <ns> <name> <chart> : Install in namespace

      Release management:
      - helm list                      : List all releases
      - helm list -A                   : List releases in all namespaces
      - helm status <release>          : Show release status
      - helm get values <release>      : Get values used in release
      - helm get manifest <release>    : Get Kubernetes manifests

      Upgrade and rollback:
      - helm upgrade <release> <chart>        : Upgrade a release
      - helm upgrade --install <release> <chart> : Install or upgrade
      - helm rollback <release> <revision>    : Rollback to previous version
      - helm history <release>                : Show release history

      Uninstall:
      - helm uninstall <release>       : Uninstall a release
      - helm uninstall <release> --keep-history : Uninstall but keep history

      Chart development:
      - helm create <chart-name>       : Create a new chart
      - helm lint <chart>              : Lint a chart
      - helm template <chart>          : Render chart templates
      - helm package <chart>           : Package chart into archive

      Popular charts for Java/Kotlin developers:

      Databases:
      - helm install postgres bitnami/postgresql
      - helm install mysql bitnami/mysql
      - helm install mongodb bitnami/mongodb
      - helm install redis bitnami/redis

      Observability:
      - helm install prometheus prometheus-community/prometheus
      - helm install grafana grafana/grafana
      - helm install jaeger jaegertracing/jaeger

      Development tools:
      - helm install jenkins jenkins/jenkins
      - helm install gitlab gitlab/gitlab
      - helm install nexus sonatype/nexus-repository-manager

      Example workflow:

      1. Add Bitnami repository:
         helm repo add bitnami https://charts.bitnami.com/bitnami

      2. Install PostgreSQL for development:
         helm install dev-postgres bitnami/postgresql \
           --set auth.postgresPassword=secretpassword \
           --set primary.persistence.size=1Gi

      3. Get connection info:
         helm status dev-postgres

      4. Connect to database:
         kubectl port-forward svc/dev-postgres-postgresql 5432:5432

      5. Upgrade with new values:
         helm upgrade dev-postgres bitnami/postgresql \
           --set auth.postgresPassword=newpassword

      6. Rollback if needed:
         helm rollback dev-postgres

      7. Clean up:
         helm uninstall dev-postgres

      Integration with kubectl:
      - Helm uses kubectl config and context
      - Helm creates standard Kubernetes resources
      - Use kubectl to inspect Helm-deployed resources
      - kubectl get all -l app.kubernetes.io/managed-by=Helm

      Best practices:
      - Always use --dry-run --debug before installing
      - Use -f values.yaml for custom configurations
      - Version your values files in git
      - Use helm diff plugin for safer upgrades
      - Keep chart repositories up to date

      Configuration:
      - Cache directory: ~/.cache/helm
      - Config directory: ~/.config/helm
      - Data directory: ~/.local/share/helm
      - Repository cache: ~/.cache/helm/repository

      Useful plugins:
      - helm-diff: Preview changes before upgrade
        helm plugin install https://github.com/databus23/helm-diff
      - helm-secrets: Manage secrets
        helm plugin install https://github.com/jkroepke/helm-secrets

      Documentation: https://helm.sh/docs/
      Chart Hub: https://artifacthub.io/
      Best Practices: https://helm.sh/docs/chart_best_practices/

      Update Helm:
      - Automatic via apt: sudo apt update && sudo apt upgrade helm
  tags:
    - helm
    - kubernetes
