---
# tasks file for home

- name: Ensure user config directory exists
  ansible.builtin.file:
    path: "{{ user_home }}/.config"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'
  tags:
    - home
    - xdg
    - configuration

- name: Setup XDG user directories configuration
  ansible.builtin.template:
    src: user-dirs.j2
    dest: "{{ user_home }}/.config/user-dirs.dirs"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'
  tags:
    - home
    - xdg
    - configuration

- name: Create custom directories in home directory
  ansible.builtin.file:
    path: "{{ user_home }}/{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'
  loop:
    - Bin
    - Archive
    - Applications
    - Desktop
    - Downloads
    - Documents
    - Projects
    - Notes
    - Media/Music
    - Media/Pictures
    - Media/Templates
    - Media/Videos
    - Workspace
    - Tmp
  tags:
    - home
    - directories

- name: Check if default XDG directories exist
  ansible.builtin.stat:
    path: "{{ user_home }}/{{ item }}"
  loop:
    - Music
    - Pictures
    - Public
    - Templates
    - Videos
  register: xdg_dirs_check
  tags:
    - home
    - cleanup

- name: Remove default XDG directories (replaced by custom structure)
  ansible.builtin.file:
    path: "{{ user_home }}/{{ item.item }}"
    state: absent
  loop: "{{ xdg_dirs_check.results }}"
  when: item.stat.exists
  tags:
    - home
    - cleanup

- name: Update XDG user directories
  ansible.builtin.command: xdg-user-dirs-update
  environment:
    HOME: "{{ user_home }}"
  become: false
  register: xdg_update_result
  changed_when: false
  failed_when: xdg_update_result.rc not in [0, 1]
  tags:
    - home
    - xdg
  # Note: xdg-user-dirs-update is idempotent and doesn't provide output
  # to indicate when changes are made. The directory creation tasks above
  # already track meaningful changes, so we mark this as unchanged.

- name: Ensure KDE user-places directory exists
  ansible.builtin.file:
    path: "{{ user_home }}/.local/share"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0755'
  tags:
    - home
    - kde
    - dolphin
    - configuration

- name: Configure Dolphin places sidebar (KDE)
  ansible.builtin.template:
    src: user-places.xbel.j2
    dest: "{{ user_home }}/.local/share/user-places.xbel"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'
    backup: true
  tags:
    - home
    - kde
    - dolphin
    - configuration