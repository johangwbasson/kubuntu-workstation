---
# tasks file for intellij

- name: Ensure Applications base directory exists
  ansible.builtin.file:
    path: "{{ intellij_install_base }}"
    state: directory
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    mode: '0755'
  tags:
    - intellij
    - ide
    - development
    - directories

- name: Ensure IntelliJ installation directory exists
  ansible.builtin.file:
    path: "{{ intellij_install_dir }}"
    state: directory
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    mode: '0755'
  tags:
    - intellij
    - ide
    - development
    - directories

- name: Check if IntelliJ IDEA is already installed
  ansible.builtin.stat:
    path: "{{ intellij_install_dir }}/bin/idea.sh"
  register: intellij_existing_install
  tags:
    - intellij
    - ide
    - development

- name: Fetch latest IntelliJ IDEA version info from JetBrains API
  ansible.builtin.uri:
    url: "{{ intellij_api_urls[intellij_edition] }}"
    method: GET
    return_content: true
    status_code: 200
  register: intellij_version_info
  when: not intellij_existing_install.stat.exists
  tags:
    - intellij
    - ide
    - development
    - api

- name: Extract IntelliJ IDEA version from API response
  ansible.builtin.set_fact:
    intellij_version: "{{ intellij_version_info.json.IIC[0].version if intellij_edition == 'community' else intellij_version_info.json.IIU[0].version }}"
    intellij_build: "{{ intellij_version_info.json.IIC[0].build if intellij_edition == 'community' else intellij_version_info.json.IIU[0].build }}"
  when:
    - not intellij_existing_install.stat.exists
    - intellij_version_info.json is defined
  tags:
    - intellij
    - ide
    - development

- name: Construct IntelliJ IDEA download URL
  ansible.builtin.set_fact:
    intellij_download_url: "{{ intellij_download_base_url }}/idea{{ 'IC' if intellij_edition == 'community' else 'IU' }}-{{ intellij_version }}.tar.gz"
  when:
    - not intellij_existing_install.stat.exists
    - intellij_version is defined
  tags:
    - intellij
    - ide
    - development

- name: Download IntelliJ IDEA ({{ intellij_edition | upper }})
  ansible.builtin.get_url:
    url: "{{ intellij_download_url }}"
    dest: "{{ intellij_download_path }}"
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    mode: '0644'
    force: false
  when:
    - not intellij_existing_install.stat.exists
    - intellij_download_url is defined
  tags:
    - intellij
    - ide
    - development
    - download
  # Note: IntelliJ IDEA downloaded from official JetBrains CDN. Security relies on HTTPS.
  # Version fetched from official JetBrains data services API.

- name: Extract IntelliJ IDEA to Applications directory
  ansible.builtin.unarchive:
    src: "{{ intellij_download_path }}"
    dest: "{{ intellij_install_dir }}"
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    remote_src: true
    extra_opts: ['--strip-components=1']
    creates: "{{ intellij_install_dir }}/bin/idea.sh"
  when: not intellij_existing_install.stat.exists
  tags:
    - intellij
    - ide
    - development
    - extract

- name: Remove IntelliJ IDEA tar.gz after extraction
  ansible.builtin.file:
    path: "{{ intellij_download_path }}"
    state: absent
  when: not intellij_existing_install.stat.exists
  tags:
    - intellij
    - ide
    - development
    - cleanup

- name: Ensure local applications directory exists
  ansible.builtin.file:
    path: "{{ intellij_user_home }}/.local/share/applications"
    state: directory
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    mode: '0755'
  tags:
    - intellij
    - ide
    - desktop

- name: Create IntelliJ IDEA desktop entry
  ansible.builtin.copy:
    dest: "{{ intellij_desktop_file_path }}"
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    mode: '0644'
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name={{ intellij_app_name }} {{ intellij_edition | title }}
      Comment={{ intellij_app_comment }}
      Exec={{ intellij_install_dir }}/bin/idea.sh %f
      Icon={{ intellij_install_dir }}/bin/idea.svg
      Terminal=false
      Categories={{ intellij_app_categories }}
      Keywords={{ intellij_app_keywords }}
      StartupWMClass=jetbrains-idea
      StartupNotify=true
      MimeType=text/plain;text/x-java;
  when: intellij_existing_install.stat.exists
  tags:
    - intellij
    - ide
    - desktop

- name: Update desktop database
  ansible.builtin.command: update-desktop-database "{{ intellij_user_home }}/.local/share/applications"
  become: true
  become_user: "{{ intellij_user }}"
  changed_when: false
  when: intellij_existing_install.stat.exists
  tags:
    - intellij
    - ide
    - desktop

- name: Ensure user bin directory exists
  ansible.builtin.file:
    path: "{{ intellij_user_home }}/.local/bin"
    state: directory
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    mode: '0755'
  tags:
    - intellij
    - ide
    - cli

- name: Create IntelliJ IDEA CLI launcher symlink
  ansible.builtin.file:
    src: "{{ intellij_install_dir }}/bin/idea.sh"
    dest: "{{ intellij_user_home }}/.local/bin/idea"
    owner: "{{ intellij_user }}"
    group: "{{ intellij_user }}"
    state: link
    force: true
  when: intellij_existing_install.stat.exists
  tags:
    - intellij
    - ide
    - cli
