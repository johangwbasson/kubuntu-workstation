---
# tasks file for java

- name: Install OpenJDK packages
  ansible.builtin.apt:
    name: "{{ java_packages }}"
    state: "{{ java_package_state }}"
    update_cache: yes
  tags:
    - java
    - jdk
    - development
    - packages

- name: Get Java installation path
  ansible.builtin.shell: |
    update-java-alternatives -l | grep java-1 | head -1 | awk '{print $3}'
  register: java_home_path
  changed_when: false
  failed_when: false
  tags:
    - java
    - jdk
    - environment

- name: Set JAVA_HOME environment variable system-wide
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^JAVA_HOME='
    line: 'JAVA_HOME="{{ java_home_path.stdout }}"'
    create: yes
  when: java_home_path.stdout != ""
  tags:
    - java
    - jdk
    - environment

- name: Create profile.d script for Java environment
  ansible.builtin.copy:
    dest: /etc/profile.d/java.sh
    content: |
      # Java environment variables
      export JAVA_HOME="{{ java_home_path.stdout }}"
      export PATH="$JAVA_HOME/bin:$PATH"
    mode: '0644'
  when: java_home_path.stdout != ""
  tags:
    - java
    - jdk
    - environment

- name: Get installed Java version
  ansible.builtin.command: java -version
  register: java_version_output
  changed_when: false
  tags:
    - java
    - jdk

- name: Get installed javac version
  ansible.builtin.command: javac -version
  register: javac_version_output
  changed_when: false
  tags:
    - java
    - jdk

- name: Display Java installation info
  ansible.builtin.debug:
    msg: |
      Java (OpenJDK) has been installed successfully!

      Installed packages:
      - OpenJDK 21 JDK (Java Development Kit)
      - OpenJDK 21 JRE (Java Runtime Environment)
      - OpenJDK Documentation
      - OpenJDK Source Code

      Java version: {{ java_version_output.stderr_lines[0] | default('N/A') }}
      Javac version: {{ javac_version_output.stderr_lines[0] | default('N/A') }}
      JAVA_HOME: {{ java_home_path.stdout }}

      Useful commands:
      - java -version              : Check Java runtime version
      - javac -version             : Check Java compiler version
      - which java                 : Location of java executable
      - update-java-alternatives -l : List installed Java versions
      - echo $JAVA_HOME            : Show Java home directory

      For Fish shell users:
      The JAVA_HOME variable is set in /etc/environment and /etc/profile.d/java.sh
      You may need to restart your shell or run: source /etc/environment

      To compile and run Java:
      1. Create HelloWorld.java
      2. Compile: javac HelloWorld.java
      3. Run: java HelloWorld

      Note: SDKMAN (installed via fish_shell role) can manage multiple Java versions.
  tags:
    - java
    - jdk
