---
# tasks file for k9s

- name: Check if k9s is already installed
  ansible.builtin.stat:
    path: "{{ k9s_binary_path }}"
  register: k9s_installed
  tags:
    - k9s
    - kubernetes
    - tools

- name: Create temporary extraction directory
  ansible.builtin.file:
    path: "{{ k9s_extract_path }}"
    state: directory
    mode: '0755'
  when: not k9s_installed.stat.exists
  tags:
    - k9s
    - kubernetes
    - tools

- name: Download k9s latest release
  ansible.builtin.get_url:
    url: "{{ k9s_download_url }}"
    dest: "{{ k9s_download_path }}"
    mode: '0644'
    force: false
  when: not k9s_installed.stat.exists
  tags:
    - k9s
    - kubernetes
    - tools
    - download
  # Note: k9s downloaded from official GitHub releases. Security relies on HTTPS.
  # k9s doesn't publish checksums for the "latest" download URL.

- name: Extract k9s archive
  ansible.builtin.unarchive:
    src: "{{ k9s_download_path }}"
    dest: "{{ k9s_extract_path }}"
    remote_src: true
    creates: "{{ k9s_extract_path }}/k9s"
  when: not k9s_installed.stat.exists
  tags:
    - k9s
    - kubernetes
    - tools
    - extract

- name: Install k9s binary to system path
  ansible.builtin.copy:
    src: "{{ k9s_extract_path }}/k9s"
    dest: "{{ k9s_binary_path }}"
    mode: '0755'
    owner: root
    group: root
    remote_src: true
  when: not k9s_installed.stat.exists
  tags:
    - k9s
    - kubernetes
    - tools

- name: Remove k9s download archive
  ansible.builtin.file:
    path: "{{ k9s_download_path }}"
    state: absent
  when: not k9s_installed.stat.exists
  tags:
    - k9s
    - kubernetes
    - tools
    - cleanup

- name: Remove k9s extraction directory
  ansible.builtin.file:
    path: "{{ k9s_extract_path }}"
    state: absent
  when: not k9s_installed.stat.exists
  tags:
    - k9s
    - kubernetes
    - tools
    - cleanup

- name: Get k9s version
  ansible.builtin.command: k9s version --short
  register: k9s_version_output
  changed_when: false
  failed_when: false
  tags:
    - k9s
    - kubernetes
    - tools
