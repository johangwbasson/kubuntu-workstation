---
# tasks file for kde

- name: Set keyboard repeat delay
  ansible.builtin.command: "kwriteconfig5 --file ~/.kde/share/config/kcminputrc InputRepeatDelay 400"
  become_user: "{{ username }}"
  tags:
    - kde

- name: Set keyboard repeat rate
  ansible.builtin.command: "kwriteconfig5 --file ~/.kde/share/config/kcminputrc InputRepeatRate 35"
  become_user: "{{ username }}"
  tags:
    - kde

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags:
    - kde
    - packages

- name: Check which KDE applications are already installed
  ansible.builtin.command: dpkg -l {{ item.name }}
  loop: "{{ kde_applications }}"
  register: kde_app_check
  changed_when: false
  failed_when: false
  tags:
    - kde
    - packages

- name: Install KDE applications
  ansible.builtin.apt:
    name: "{{ kde_applications | map(attribute='name') | list }}"
    state: "{{ kde_package_state }}"
    install_recommends: "{{ kde_install_recommends }}"
    update_cache: "{{ kde_update_cache }}"
  tags:
    - kde
    - packages

- name: Verify VLC installation
  ansible.builtin.command: vlc --version
  register: vlc_version
  changed_when: false
  failed_when: false
  tags:
    - kde
    - vlc
    - multimedia

- name: Verify GIMP installation
  ansible.builtin.command: gimp --version
  register: gimp_version
  changed_when: false
  failed_when: false
  tags:
    - kde
    - gimp
    - graphics

- name: Verify Meld installation
  ansible.builtin.command: meld --version
  register: meld_version
  changed_when: false
  failed_when: false
  tags:
    - kde
    - meld
    - development

- name: Ensure Flatpak is installed
  ansible.builtin.apt:
    name: flatpak
    state: present
  tags:
    - kde
    - flatpak
    - packages

- name: Install KDE Flatpak applications
  community.general.flatpak:
    name: "{{ item.name }}"
    state: present
    remote: "{{ kde_flatpak_remote }}"
    method: "{{ kde_flatpak_method }}"
  loop: "{{ kde_flatpak_apps }}"
  tags:
    - kde
    - flatpak
    - development

# Include KDE task switcher configuration
- name: Configure KDE task switcher
  ansible.builtin.include_tasks: taskswitcher.yml
  when: kde_taskswitcher_enabled | default(true)
  tags:
    - kde
    - taskswitcher

# Include KDE keyboard shortcuts configuration
- name: Configure KDE keyboard shortcuts
  ansible.builtin.include_tasks: shortcuts.yml
  when: kde_shortcuts_enabled | default(true)
  tags:
    - kde
    - kde_shortcuts
