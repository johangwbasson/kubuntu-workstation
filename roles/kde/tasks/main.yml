---
# tasks file for kde

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  tags:
    - kde
    - packages

- name: Check which KDE applications are already installed
  ansible.builtin.command: dpkg -l {{ item.name }}
  loop: "{{ kde_applications }}"
  register: kde_app_check
  changed_when: false
  failed_when: false
  tags:
    - kde
    - packages

- name: Install KDE applications
  ansible.builtin.apt:
    name: "{{ kde_applications | map(attribute='name') | list }}"
    state: "{{ kde_package_state }}"
    install_recommends: "{{ kde_install_recommends }}"
    update_cache: "{{ kde_update_cache }}"
  tags:
    - kde
    - packages

- name: Verify VLC installation
  ansible.builtin.command: vlc --version
  register: vlc_version
  changed_when: false
  failed_when: false
  tags:
    - kde
    - vlc
    - multimedia

- name: Verify GIMP installation
  ansible.builtin.command: gimp --version
  register: gimp_version
  changed_when: false
  failed_when: false
  tags:
    - kde
    - gimp
    - graphics

- name: Verify Meld installation
  ansible.builtin.command: meld --version
  register: meld_version
  changed_when: false
  failed_when: false
  tags:
    - kde
    - meld
    - development

- name: Ensure Flatpak is installed
  ansible.builtin.apt:
    name: flatpak
    state: present
  tags:
    - kde
    - flatpak
    - packages

- name: Install KDE Flatpak applications
  community.general.flatpak:
    name: "{{ item.name }}"
    state: present
    remote: "{{ kde_flatpak_remote }}"
    method: "{{ kde_flatpak_method }}"
  loop: "{{ kde_flatpak_apps }}"
  tags:
    - kde
    - flatpak
    - development

- name: Display KDE applications installation info
  ansible.builtin.debug:
    msg: |
      KDE Applications have been installed successfully!

      ═══════════════════════════════════════════════════════════════
      MULTIMEDIA APPLICATIONS
      ═══════════════════════════════════════════════════════════════

      VLC Media Player
      ────────────────
      {% if vlc_version.rc == 0 %}
      ✓ Installed: {{ vlc_version.stdout_lines[0] }}
      {% endif %}
      Description: Universal media player supporting most video/audio formats
      Launch: vlc or search "VLC" in application menu
      Features:
        • Plays almost any video/audio format
        • Network streaming (HTTP, RTP, RTSP, etc.)
        • Video conversion and transcoding
        • Subtitle support
        • Audio/video effects
        • Playlist management
      Useful shortcuts:
        • Space: Play/Pause
        • F: Fullscreen
        • Ctrl+H: Hide/show controls
        • Ctrl+J: Advanced controls

      Kamoso
      ──────
      Description: Webcam recorder and photo booth application
      Launch: kamoso or search "Kamoso" in application menu
      Features:
        • Take photos with webcam
        • Record videos
        • Apply effects
        • Burst mode

      ═══════════════════════════════════════════════════════════════
      DOCUMENT VIEWERS
      ═══════════════════════════════════════════════════════════════

      Okular
      ──────
      Description: Universal document viewer
      Launch: okular or right-click document → Open With → Okular
      Supported formats:
        • PDF (with annotations)
        • ePub (e-books)
        • Markdown
        • Comic books (CBR, CBZ)
        • DjVu, TIFF, CHM
      Features:
        • PDF annotations (highlight, notes, drawings)
        • Form filling
        • Digital signatures
        • Text-to-speech
        • Presentation mode

      ═══════════════════════════════════════════════════════════════
      GRAPHICS APPLICATIONS
      ═══════════════════════════════════════════════════════════════

      GIMP
      ────
      {% if gimp_version.rc == 0 %}
      ✓ Installed: {{ gimp_version.stdout_lines[0] }}
      {% endif %}
      Description: GNU Image Manipulation Program (like Photoshop)
      Launch: gimp or search "GIMP" in application menu
      Features:
        • Photo retouching and enhancement
        • Image composition and editing
        • Layers and masks
        • Filters and effects
        • Brushes and drawing tools
        • Color correction
        • Format conversion
      Useful plugins:
        • G'MIC: Advanced filters
        • Resynthesizer: Content-aware fill
      Learning resources:
        • Official docs: https://docs.gimp.org/
        • Tutorials: https://www.gimp.org/tutorials/

      ═══════════════════════════════════════════════════════════════
      DEVELOPMENT TOOLS
      ═══════════════════════════════════════════════════════════════

      Meld
      ────
      {% if meld_version.rc == 0 %}
      ✓ Installed: {{ meld_version.stdout_lines[0] }}
      {% endif %}
      Description: Visual diff and merge tool for files and directories
      Launch: meld or meld file1 file2
      Features:
        • File comparison (2-way and 3-way)
        • Directory comparison
        • Merge conflicts resolution
        • Git integration
        • Syntax highlighting
      Usage:
        • Compare 2 files: meld file1.txt file2.txt
        • Compare 3 files: meld file1.txt base.txt file2.txt
        • Compare directories: meld dir1/ dir2/
        • Git integration: git difftool -t meld

      Okteta
      ──────
      Description: Hex/binary editor
      Launch: okteta or search "Okteta" in application menu
      Features:
        • Hexadecimal and binary editing
        • Structure viewer
        • Checksums (MD5, SHA-1, SHA-256)
        • Character encoding support
        • Search and replace
      Use cases:
        • Binary file analysis
        • Reverse engineering
        • File corruption repair
        • Data extraction

      Kommit (Flatpak)
      ────────────────
      Description: Git client for KDE
      Launch: flatpak run org.kde.kommit or search "Kommit" in application menu
      Features:
        • Visual Git interface
        • Commit history browsing
        • Diff viewer
        • Branch management
        • Merge and rebase support
        • Blame annotations
      Note: Installed via Flatpak for latest version

      ═══════════════════════════════════════════════════════════════
      KDE UTILITIES
      ═══════════════════════════════════════════════════════════════

      Spectacle
      ─────────
      Description: Screenshot capture utility
      Launch: spectacle or use default shortcuts
      Default shortcuts:
        • Print Screen: Capture entire screen
        • Shift+Print Screen: Capture current window
        • Meta+Shift+Print Screen: Capture rectangular region
      Features:
        • Capture screen, window, or region
        • Delayed capture
        • Annotation tools
        • Multiple output formats
        • Direct upload to online services
      Settings: Configure in System Settings → Shortcuts

      Yakuake
      ───────
      Description: Drop-down terminal emulator (Quake-style)
      Launch: yakuake (starts in background)
      Default shortcut: F12 (toggle terminal)
      Features:
        • Quick access terminal (drops from top of screen)
        • Multiple tabs
        • Split terminals
        • Configurable appearance
        • Always available in background
      Configuration:
        • Right-click → Configure Yakuake
        • Change shortcut in settings
        • Customize appearance and behavior
      Tips:
        • F12: Show/hide terminal
        • Ctrl+Shift+T: New tab
        • Shift+Left/Right: Switch tabs
        • Enable "Start Yakuake at login" for always-available terminal

      Filelight
      ─────────
      Description: Disk usage analyzer and visualizer
      Launch: filelight or search "Filelight" in application menu
      Features:
        • Interactive sunburst chart
        • Identify large files and folders
        • Visual representation of disk usage
        • Drill down into directories
        • Compare sizes at a glance
      Usage:
        • Scan home directory: filelight ~
        • Scan specific path: filelight /path/to/directory
        • Click segments to drill down
        • Right-click for context menu (delete, properties)

      ═══════════════════════════════════════════════════════════════
      SECURITY & ENCRYPTION
      ═══════════════════════════════════════════════════════════════

      KGpg
      ────
      Description: GPG encryption interface for KDE
      Launch: kgpg or search "KGpg" in application menu
      Features:
        • GPG key management
        • Encrypt/decrypt files
        • Sign and verify signatures
        • Key import/export
        • Key server integration
      Usage:
        • Generate key: KGpg → File → Generate Key Pair
        • Encrypt file: Right-click file → Encrypt File
        • Sign file: Right-click file → Sign File
        • Manage keys: View and edit keys in main window

      Kleopatra
      ─────────
      Description: Certificate manager and cryptography GUI
      Launch: kleopatra or search "Kleopatra" in application menu
      Features:
        • OpenPGP and X.509 certificate management
        • Email encryption (S/MIME, OpenPGP)
        • File encryption and signing
        • Smart card support
        • Certificate validation
      Usage:
        • Create OpenPGP key: File → New OpenPGP Key Pair
        • Import certificate: File → Import Certificates
        • Encrypt file: File → Sign/Encrypt Files
        • Integration with KMail for email encryption

      ═══════════════════════════════════════════════════════════════
      FILE MANAGEMENT
      ═══════════════════════════════════════════════════════════════

      Krusader
      ────────
      Description: Advanced twin-panel file manager (like Total Commander)
      Launch: krusader or search "Krusader" in application menu
      Features:
        • Twin-panel interface
        • Archive handling (tar, zip, rar, 7z)
        • Advanced search
        • Batch rename
        • File synchronization
        • FTP/SFTP support
        • Internal viewers/editors
        • User actions and scripts
      Keyboard shortcuts:
        • Tab: Switch between panels
        • Ctrl+U: Swap panels
        • F3: View file
        • F4: Edit file
        • F5: Copy
        • F6: Move
        • F7: Create directory
        • F8: Delete
        • Ctrl+R: Refresh
      Configuration: Settings → Configure Krusader

      ═══════════════════════════════════════════════════════════════
      PRODUCTIVITY
      ═══════════════════════════════════════════════════════════════

      Zanshin
      ───────
      Description: To-do list and task management (Getting Things Done)
      Launch: zanshin or search "Zanshin" in application menu
      Features:
        • GTD (Getting Things Done) methodology
        • Projects and contexts
        • Task prioritization
        • Due dates and reminders
        • Akonadi integration
        • Quick entry
      Usage:
        • Add task: Click "Add task" or press Insert
        • Create project: Right-click → New Project
        • Set context: Drag task to context
        • Mark complete: Check the checkbox

      Akregator
      ─────────
      Description: RSS/Atom feed reader
      Launch: akregator or search "Akregator" in application menu
      Features:
        • RSS and Atom feed support
        • Built-in browser
        • Feed organization (folders)
        • Article archiving
        • Search functionality
        • OPML import/export
      Usage:
        • Add feed: Feed → Add Feed
        • Import feeds: File → Import Feeds (OPML)
        • Mark as read: Ctrl+R
        • Next unread: Ctrl+Shift+Space
      Tips:
        • Organize feeds into folders for better management
        • Use filters to highlight important articles
        • Configure refresh intervals per feed

      ═══════════════════════════════════════════════════════════════
      SYSTEM INTEGRATION
      ═══════════════════════════════════════════════════════════════

      All applications are integrated with KDE Plasma:
      • Available in application launcher (search by name)
      • Context menu integration (right-click files)
      • System tray integration (where applicable)
      • KDE color schemes and themes applied
      • Notification system integration

      ═══════════════════════════════════════════════════════════════
      CONFIGURATION & CUSTOMIZATION
      ═══════════════════════════════════════════════════════════════

      Application Settings:
      • Most KDE apps: Settings → Configure [AppName]
      • Keyboard shortcuts: Settings → Configure Keyboard Shortcuts
      • Look and feel: Follows system color scheme

      System Settings Integration:
      • Default applications: System Settings → Applications
      • File associations: System Settings → Applications → File Associations
      • Shortcuts: System Settings → Shortcuts

      ═══════════════════════════════════════════════════════════════
      QUICK REFERENCE
      ═══════════════════════════════════════════════════════════════

      Multimedia:       vlc, kamoso
      Documents:        okular
      Graphics:         gimp
      Development:      meld, okteta, kommit (Flatpak)
      Utilities:        spectacle (kde-spectacle), yakuake, filelight
      Security:         kgpg, kleopatra
      File Management:  krusader
      Productivity:     zanshin, akregator

      Total APT applications: {{ kde_applications | length }}
      Total Flatpak applications: {{ kde_flatpak_apps | length }}

      ═══════════════════════════════════════════════════════════════

      APT applications will receive automatic updates through APT.
      Flatpak applications can be updated with: flatpak update
  tags:
    - kde
    - packages
