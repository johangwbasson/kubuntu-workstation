---
# KDE Keyboard Shortcuts Configuration (KDE 5 & 6 compatible)

- name: Detect KDE Plasma version
  ansible.builtin.shell: |
    set -o pipefail
    if command -v plasmashell &> /dev/null; then
      plasmashell --version 2>/dev/null | grep -oP 'plasmashell \K[0-9]+' | head -1
    elif command -v kwriteconfig6 &> /dev/null; then
      echo "6"
    elif command -v kwriteconfig5 &> /dev/null; then
      echo "5"
    else
      echo "0"
    fi
  args:
    executable: /bin/bash
  register: kde_plasma_version_detect
  changed_when: false
  tags:
    - kde_shortcuts
    - detection

- name: Set KDE version and tool names
  ansible.builtin.set_fact:
    kde_version: "{{ kde_plasma_version_detect.stdout | int }}"
    kde_write_config: "{{ 'kwriteconfig6' if kde_plasma_version_detect.stdout | int >= 6 else 'kwriteconfig5' }}"
    kde_read_config: "{{ 'kreadconfig6' if kde_plasma_version_detect.stdout | int >= 6 else 'kreadconfig5' }}"
    kde_qdbus: "{{ 'qdbus6' if kde_plasma_version_detect.stdout | int >= 6 else 'qdbus' }}"
  tags:
    - kde_shortcuts

- name: Display detected KDE version
  ansible.builtin.debug:
    msg: |
      Detected KDE Plasma version: {{ kde_version }}
      Using tools: {{ kde_write_config }}, {{ kde_read_config }}, {{ kde_qdbus }}
      Configuring {{ kde_custom_shortcuts | length }} custom shortcuts
  tags:
    - kde_shortcuts

- name: Ensure KDE CLI tools are installed
  ansible.builtin.apt:
    name: kde-cli-tools
    state: present
  when: kde_version | int > 0
  tags:
    - kde_shortcuts
    - packages

- name: Ensure khotkeys is installed (for custom shortcuts)
  ansible.builtin.apt:
    name: khotkeys
    state: present
  when: kde_version | int > 0
  failed_when: false
  tags:
    - kde_shortcuts
    - packages

- name: Note about khotkeysrc
  ansible.builtin.debug:
    msg: |
      KDE custom shortcuts are now managed through kglobalshortcutsrc instead of khotkeysrc.
      The khotkeysrc file is system-managed and gets merged with system defaults,
      making it unreliable for custom shortcut configuration.
  tags:
    - kde_shortcuts

- name: Create temporary shortcuts JSON file
  become: true
  become_user: "{{ kde_shortcuts_user }}"
  ansible.builtin.copy:
    content: "{{ kde_custom_shortcuts | to_json }}"
    dest: "{{ kde_shortcuts_user_home }}/.config/shortcuts.json.tmp"
    mode: '0600'
  when:
    - kde_version | int > 0
    - kde_shortcuts_enabled | default(true)
  tags:
    - kde_shortcuts

- name: Update KDE shortcuts using kwriteconfig5
  become: true
  become_user: "{{ kde_shortcuts_user }}"
  ansible.builtin.script: update_shortcuts_kwrite.py "{{ kde_shortcuts_user_home }}"
  args:
    executable: /usr/bin/python3
  when:
    - kde_version | int > 0
    - kde_shortcuts_enabled | default(true)
  register: shortcuts_configured
  changed_when: '"changed=true" in shortcuts_configured.stdout'
  tags:
    - kde_shortcuts

- name: Clean up temporary shortcuts JSON file
  become: true
  become_user: "{{ kde_shortcuts_user }}"
  ansible.builtin.file:
    path: "{{ kde_shortcuts_user_home }}/.config/shortcuts.json.tmp"
    state: absent
  when:
    - kde_version | int > 0
    - kde_shortcuts_enabled | default(true)
  tags:
    - kde_shortcuts

- name: Reload khotkeys configuration
  become: true
  become_user: "{{ kde_shortcuts_user }}"
  ansible.builtin.shell: |
    {{ kde_qdbus }} org.kde.kded5 /modules/khotkeys reread_configuration 2>/dev/null || \
    {{ kde_qdbus }} org.kde.kded6 /modules/khotkeys reread_configuration 2>/dev/null || true
  when:
    - kde_version | int > 0
    - kde_custom_shortcuts is defined
    - kde_custom_shortcuts | length > 0
  changed_when: false
  failed_when: false
  environment:
    DISPLAY: ":0"
  tags:
    - kde_shortcuts

- name: Display KDE shortcuts configuration summary
  ansible.builtin.debug:
    msg: |
      ================================================================================
      KDE {{ kde_version }} Custom Keyboard Shortcuts Configured Successfully!
      ================================================================================

      Configured {{ kde_custom_shortcuts | length }} custom shortcuts:

      System/Utilities:
      - Super + Return    : Launch Yakuake (drop-down terminal)
      - Super + P         : Launch KRunner (application launcher)

      Scripts (MEGA directory):
      - Super + J         : Run capture.sh
      - Super + R         : Run report.sh
      - Super + A         : Run get-key.sh

      Development Applications:
      - Super + U         : Launch VS Code
      - Super + I         : Launch IntelliJ IDEA
      - Super + K         : Launch Kwrite
      - Super + S         : Launch Sublime Text
      - Super + O         : Launch Obsidian
      - Super + C         : Launch Chrome

      Configuration:
      - Config file: ~/.config/kglobalshortcutsrc (khotkeys section)
      - Tools used: {{ kde_write_config }}, {{ kde_read_config }}
      - Total shortcuts configured: {{ kde_custom_shortcuts | length }}

      To apply changes:
      - Shortcuts should be active immediately
      - If not working, log out and log back in
      - Or reload configuration: {{ kde_qdbus }} org.kde.kded{{ kde_version }} /modules/khotkeys reread_configuration

      Verify shortcuts:
      - Test each key combination
      - Check System Settings → Shortcuts → Custom Shortcuts
      - View config section: grep -A {{ kde_custom_shortcuts | length }} "^\[khotkeys\]" ~/.config/kglobalshortcutsrc

      Notes:
      - Shortcuts configured using kwriteconfig5 (KDE's official config tool)
      - Key bindings stored in kglobalshortcutsrc [khotkeys] section
      - Commands stored in khotkeysrc [Data_N] sections
      - Scripts are referenced from: ~/MEGA/Applications/
      - Make sure scripts are executable: chmod +x ~/MEGA/Applications/*.sh
      - Applications will launch if installed, otherwise shortcut does nothing

      Troubleshooting:
      - If shortcuts don't work: System Settings → Shortcuts → Custom Shortcuts
      - Check for conflicts with existing shortcuts
      - Verify applications are in PATH: which code, which idea, etc.
      - Check script permissions: ls -la ~/MEGA/Applications/
      - Verify kglobalshortcutsrc has correct entries: grep "00000000-0000" ~/.config/kglobalshortcutsrc

      ================================================================================
  when: kde_version | int > 0
  tags:
    - kde_shortcuts
