---
# tasks file for kernel_module_blacklist

- name: Check if kernel modules are currently loaded
  ansible.builtin.shell: |
    set -o pipefail
    lsmod | grep -E "{{ blacklisted_modules | join('|') }}" || true
  args:
    executable: /bin/bash
  register: loaded_modules
  changed_when: false
  tags:
    - kernel_modules
    - blacklist
    - system
    - hardware

- name: Create blacklist configuration file for kernel modules
  ansible.builtin.copy:
    dest: "{{ blacklist_conf_path }}"
    content: |
      # Kernel module blacklist managed by Ansible
      # This file prevents specific kernel modules from loading automatically
      #
      # Generated on: {{ ansible_facts['date_time']['iso8601'] }}
      # Managed by: kernel_module_blacklist role

      {% for module in blacklisted_modules %}
      # Blacklist {{ module }} module
      blacklist {{ module }}
      install {{ module }} /bin/true

      {% endfor %}
    mode: '0644'
    owner: root
    group: root
  notify: Update initramfs
  tags:
    - kernel_modules
    - blacklist
    - system
    - hardware

- name: Unload blacklisted kernel modules if currently loaded
  community.general.modprobe:
    name: "{{ item }}"
    state: absent
  loop: "{{ blacklisted_modules }}"
  when: loaded_modules.stdout | regex_search(item) is not none
  failed_when: false
  tags:
    - kernel_modules
    - blacklist
    - system
    - hardware

- name: Verify modules are not loaded
  ansible.builtin.shell: |
    set -o pipefail
    lsmod | grep -E "{{ blacklisted_modules | join('|') }}" || true
  args:
    executable: /bin/bash
  register: modules_after_unload
  changed_when: false
  tags:
    - kernel_modules
    - blacklist
    - system
    - hardware
