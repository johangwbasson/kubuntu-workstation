---
# tasks file for lazydocker

- name: Install dependencies for lazydocker installation
  ansible.builtin.apt:
    name:
      - curl
      - tar
      - gzip
    state: present
    update_cache: true
  tags:
    - lazydocker
    - packages
    - docker
    - development
    - containers
    - dependencies

- name: Check if lazydocker is already installed
  ansible.builtin.command: lazydocker --version
  register: lazydocker_installed
  changed_when: false
  failed_when: false
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Get system architecture
  ansible.builtin.command: uname -m
  register: system_arch
  changed_when: false
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Set architecture for download
  ansible.builtin.set_fact:
    lazydocker_arch: "{{ 'x86_64' if system_arch.stdout == 'x86_64' else 'armv6' if system_arch.stdout.startswith('arm') else system_arch.stdout }}"
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Get latest lazydocker version from GitHub
  ansible.builtin.uri:
    url: "{{ lazydocker_github_api }}"
    return_content: true
  register: lazydocker_release
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Set lazydocker version
  ansible.builtin.set_fact:
    lazydocker_version: "{{ lazydocker_release.json.tag_name }}"
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Create temporary directory for lazydocker installation
  ansible.builtin.file:
    path: "{{ lazydocker_temp_dir }}"
    state: directory
    mode: '0755'
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Get lazydocker checksums file
  ansible.builtin.uri:
    url: "https://github.com/jesseduffield/lazydocker/releases/download/{{ lazydocker_version }}/lazydocker_{{ lazydocker_version | regex_replace('^v', '') }}_checksums.txt"
    return_content: true
  register: lazydocker_checksums
  when: lazydocker_installed.rc != 0
  failed_when: false
  tags:
    - lazydocker
    - docker
    - development
    - containers
    - download

- name: Extract checksum for our architecture
  ansible.builtin.set_fact:
    lazydocker_checksum: "{{ (lazydocker_checksums.content | regex_search('([a-f0-9]{64})\\s+lazydocker_' + (lazydocker_version | regex_replace('^v', '')) + '_Linux_' + lazydocker_arch + '.tar.gz', '\\1')) }}"
  when:
    - lazydocker_installed.rc != 0
    - lazydocker_checksums.status == 200
  tags:
    - lazydocker
    - docker
    - development
    - containers
    - download

- name: Download lazydocker archive
  ansible.builtin.get_url:
    url: "{{ lazydocker_download_url }}"
    dest: "{{ lazydocker_temp_dir }}/lazydocker.tar.gz"
    checksum: "{{ 'sha256:' + lazydocker_checksum[0] if lazydocker_checksum is defined and lazydocker_checksum else omit }}"
    mode: '0644'
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers
    - download

- name: Extract lazydocker archive
  ansible.builtin.unarchive:
    src: "{{ lazydocker_temp_dir }}/lazydocker.tar.gz"
    dest: "{{ lazydocker_temp_dir }}"
    remote_src: true
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Install lazydocker binary
  ansible.builtin.copy:
    src: "{{ lazydocker_temp_dir }}/lazydocker"
    dest: "{{ lazydocker_install_path }}"
    mode: '0755'
    remote_src: true
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers

- name: Clean up installation files
  ansible.builtin.file:
    path: "{{ lazydocker_temp_dir }}"
    state: absent
  when: lazydocker_installed.rc != 0
  tags:
    - lazydocker
    - docker
    - development
    - containers
    - cleanup

- name: Verify lazydocker installation
  ansible.builtin.command: lazydocker --version
  register: lazydocker_version_output
  changed_when: false
  tags:
    - lazydocker
    - docker
    - development
    - containers