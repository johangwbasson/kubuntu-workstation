---
# tasks file for lazyvim

- name: Install dependencies for LazyVim
  ansible.builtin.apt:
    name:
      - git
      - make
      - unzip
      - gcc
      - g++
      - ripgrep
      - fd-find
      - curl
    state: present
    update_cache: true
  tags:
    - lazyvim
    - neovim
    - packages
    - development
    - editor
    - dependencies

- name: Ensure Neovim is installed
  ansible.builtin.apt:
    name: neovim
    state: present
  tags:
    - lazyvim
    - neovim
    - packages
    - development
    - editor
    - dependencies

- name: Check if LazyVim is already installed
  ansible.builtin.stat:
    path: "{{ lazyvim_config_dir }}/lua/config/lazy.lua"
  register: lazyvim_installed
  become: true
  become_user: "{{ lazyvim_user }}"
  tags:
    - lazyvim
    - neovim
    - development
    - editor

- name: Backup existing Neovim configuration if it exists
  ansible.builtin.command:
    cmd: mv {{ lazyvim_config_dir }} {{ lazyvim_backup_dir }}
  args:
    removes: "{{ lazyvim_config_dir }}"
    creates: "{{ lazyvim_backup_dir }}"
  when: not lazyvim_installed.stat.exists
  become: true
  become_user: "{{ lazyvim_user }}"
  tags:
    - lazyvim
    - neovim
    - development
    - editor
    - backup

- name: Backup existing Neovim data if it exists
  ansible.builtin.command:
    cmd: mv {{ lazyvim_data_dir }} {{ lazyvim_data_backup_dir }}
  args:
    removes: "{{ lazyvim_data_dir }}"
    creates: "{{ lazyvim_data_backup_dir }}"
  when: not lazyvim_installed.stat.exists
  become: true
  become_user: "{{ lazyvim_user }}"
  tags:
    - lazyvim
    - neovim
    - development
    - editor
    - backup

- name: Backup existing Neovim state if it exists
  ansible.builtin.command:
    cmd: mv {{ lazyvim_state_dir }} {{ lazyvim_state_backup_dir }}
  args:
    removes: "{{ lazyvim_state_dir }}"
    creates: "{{ lazyvim_state_backup_dir }}"
  when: not lazyvim_installed.stat.exists
  become: true
  become_user: "{{ lazyvim_user }}"
  tags:
    - lazyvim
    - neovim
    - development
    - editor
    - backup

- name: Backup existing Neovim cache if it exists
  ansible.builtin.command:
    cmd: mv {{ lazyvim_cache_dir }} {{ lazyvim_cache_backup_dir }}
  args:
    removes: "{{ lazyvim_cache_dir }}"
    creates: "{{ lazyvim_cache_backup_dir }}"
  when: not lazyvim_installed.stat.exists
  become: true
  become_user: "{{ lazyvim_user }}"
  tags:
    - lazyvim
    - neovim
    - development
    - editor
    - backup

- name: Clone LazyVim starter configuration
  ansible.builtin.git:
    repo: "{{ lazyvim_starter_repo }}"
    dest: "{{ lazyvim_config_dir }}"
    version: main
    force: false
  when: not lazyvim_installed.stat.exists
  become: true
  become_user: "{{ lazyvim_user }}"
  tags:
    - lazyvim
    - neovim
    - development
    - editor

- name: Remove .git directory from LazyVim config
  ansible.builtin.file:
    path: "{{ lazyvim_config_dir }}/.git"
    state: absent
  when: not lazyvim_installed.stat.exists
  become: true
  become_user: "{{ lazyvim_user }}"
  tags:
    - lazyvim
    - neovim
    - development
    - editor