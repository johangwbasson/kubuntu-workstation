---
# tasks file for openssh_server

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags:
    - openssh
    - ssh
    - security
    - packages

- name: Install OpenSSH server
  ansible.builtin.apt:
    name: openssh-server
    state: present
  tags:
    - openssh
    - ssh
    - security
    - packages

- name: Install fail2ban
  ansible.builtin.apt:
    name: fail2ban
    state: present
  when: fail2ban_enabled | default(true)
  tags:
    - openssh
    - ssh
    - security
    - fail2ban
    - packages

- name: Ensure SSH directory exists
  ansible.builtin.file:
    path: /etc/ssh
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - openssh
    - ssh
    - security

- name: Ensure SSH privilege separation directory exists
  ansible.builtin.file:
    path: /run/sshd
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - openssh
    - ssh
    - security

- name: Configure SSH server
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
    backup: true
  loop:
    - { regexp: '^#?Port', line: 'Port {{ ssh_port }}' }
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin {{ ssh_permit_root_login }}' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication {{ ssh_password_authentication }}' }
    - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication {{ ssh_pubkey_authentication }}' }
    - { regexp: '^#?PermitEmptyPasswords', line: 'PermitEmptyPasswords {{ ssh_permit_empty_passwords }}' }
    - { regexp: '^#?ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication {{ ssh_challenge_response_auth }}' }
    - { regexp: '^#?UsePAM', line: 'UsePAM {{ ssh_use_pam }}' }
    - { regexp: '^#?X11Forwarding', line: 'X11Forwarding {{ ssh_x11_forwarding }}' }
    - { regexp: '^#?PrintMotd', line: 'PrintMotd {{ ssh_print_motd }}' }
    - { regexp: '^#?AcceptEnv', line: 'AcceptEnv {{ ssh_accept_env }}' }
    - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries {{ ssh_max_auth_tries }}' }
    - { regexp: '^#?MaxSessions', line: 'MaxSessions {{ ssh_max_sessions }}' }
    - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval {{ ssh_client_alive_interval }}' }
    - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax {{ ssh_client_alive_count_max }}' }
  notify: restart ssh
  tags:
    - openssh
    - ssh
    - security
    - configuration

- name: Ensure SSH service is enabled and started
  ansible.builtin.service:
    name: ssh
    state: started
    enabled: true
  tags:
    - openssh
    - ssh
    - security
    - service

- name: Configure fail2ban SSH jail
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
    backup: true
  when: fail2ban_enabled | default(true)
  notify: restart fail2ban
  tags:
    - openssh
    - ssh
    - security
    - fail2ban
    - configuration

- name: Ensure fail2ban service is enabled and started
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
  when: fail2ban_enabled | default(true)
  tags:
    - openssh
    - ssh
    - security
    - fail2ban
    - service

- name: Get SSH service status
  ansible.builtin.command: systemctl status ssh
  register: ssh_status
  changed_when: false
  failed_when: false
  tags:
    - openssh
    - ssh
    - security

- name: Get fail2ban status
  ansible.builtin.command: fail2ban-client status sshd
  register: fail2ban_status
  changed_when: false
  failed_when: false
  when: fail2ban_enabled | default(true)
  tags:
    - openssh
    - ssh
    - security
    - fail2ban

- name: Display OpenSSH server installation info
  ansible.builtin.debug:
    msg: |
      OpenSSH Server has been installed and configured successfully!

      ═══════════════════════════════════════════════════════════════
      SSH SERVER CONFIGURATION
      ═══════════════════════════════════════════════════════════════

      SSH Service:
      - Port: {{ ssh_port }}
      - Status: {{ 'Running' if ssh_status.rc == 0 else 'Not running' }}
      - Enabled on boot: Yes
      - Config file: /etc/ssh/sshd_config

      Security Settings:
      - Root login: {{ ssh_permit_root_login }}
      - Password authentication: {{ ssh_password_authentication }}
      - Public key authentication: {{ ssh_pubkey_authentication }}
      - Empty passwords: {{ ssh_permit_empty_passwords }}
      - Max auth tries: {{ ssh_max_auth_tries }}
      - Max sessions: {{ ssh_max_sessions }}

      Connection Settings:
      - Client alive interval: {{ ssh_client_alive_interval }} seconds
      - Client alive count max: {{ ssh_client_alive_count_max }}
      - X11 forwarding: {{ ssh_x11_forwarding }}

      ═══════════════════════════════════════════════════════════════
      FAIL2BAN PROTECTION
      ═══════════════════════════════════════════════════════════════

      {% if fail2ban_enabled %}
      Fail2ban Status: Enabled and running
      - Protected ports: {{ fail2ban_ssh_port }}
      - Ban time: {{ fail2ban_bantime }} seconds ({{ (fail2ban_bantime / 3600) | int }} hour{{ 's' if (fail2ban_bantime / 3600) | int != 1 else '' }})
      - Find time: {{ fail2ban_findtime }} seconds ({{ (fail2ban_findtime / 60) | int }} minutes)
      - Max retry: {{ fail2ban_maxretry }} attempts
      - Action: {{ fail2ban_action }}
      - Email alerts: {{ fail2ban_destemail }}

      Current SSH jail status:
      {% if fail2ban_status.rc == 0 %}
      {{ fail2ban_status.stdout }}
      {% else %}
      Status unavailable - service may still be starting
      {% endif %}
      {% else %}
      Fail2ban: Disabled
      {% endif %}

      ═══════════════════════════════════════════════════════════════
      CONNECTING TO THIS SERVER
      ═══════════════════════════════════════════════════════════════

      From another machine:
      ssh {{ ansible_user_id }}@{{ ansible_default_ipv4.address | default(ansible_hostname) }}
      {%- if ssh_port != 22 %} -p {{ ssh_port }}{% endif %}

      Using SSH keys (recommended):
      1. Generate key on client: ssh-keygen -t ed25519 -C "your_email@example.com"
      2. Copy to server:
         ssh-copy-id {{ ansible_user_id }}@{{ ansible_default_ipv4.address | default(ansible_hostname) }}
         {%- if ssh_port != 22 %} -p {{ ssh_port }}{% endif %}

      3. After SSH keys are set up, disable password authentication:
         - Edit /etc/ssh/sshd_config
         - Set: PasswordAuthentication no
         - Restart SSH: sudo systemctl restart ssh

      ═══════════════════════════════════════════════════════════════
      SECURITY RECOMMENDATIONS
      ═══════════════════════════════════════════════════════════════

      1. Use SSH keys instead of passwords
         - More secure than passwords
         - Cannot be brute-forced
         - Set PasswordAuthentication to "no" after setting up keys

      2. Change default SSH port (optional)
         - Reduces automated attacks
         - Update ssh_port variable and re-run playbook

      3. Use firewall (UFW role recommended)
         - Allow SSH port: sudo ufw allow {{ ssh_port }}/tcp
         - Enable firewall: sudo ufw enable

      4. Monitor fail2ban logs
         - Check bans: sudo fail2ban-client status sshd
         - View logs: sudo tail -f /var/log/fail2ban.log
         - Unban IP: sudo fail2ban-client set sshd unbanip <IP>

      5. Regular security updates
         - Unattended upgrades role recommended
         - Manual updates: sudo apt update && sudo apt upgrade

      6. Use strong passwords or passphrases
         - If using password authentication
         - Minimum 16 characters recommended

      ═══════════════════════════════════════════════════════════════
      USEFUL COMMANDS
      ═══════════════════════════════════════════════════════════════

      SSH Server:
      - Check status: sudo systemctl status ssh
      - Restart: sudo systemctl restart ssh
      - Test config: sudo sshd -t
      - View connections: ss -tunap | grep :{{ ssh_port }}
      - View auth log: sudo tail -f /var/log/auth.log

      Fail2ban:
      - Check status: sudo fail2ban-client status
      - SSH jail status: sudo fail2ban-client status sshd
      - Unban IP: sudo fail2ban-client set sshd unbanip <IP>
      - Ban IP manually: sudo fail2ban-client set sshd banip <IP>
      - View banned IPs: sudo fail2ban-client get sshd banned
      - Reload config: sudo fail2ban-client reload

      ═══════════════════════════════════════════════════════════════
      TROUBLESHOOTING
      ═══════════════════════════════════════════════════════════════

      Cannot connect:
      1. Check SSH service: sudo systemctl status ssh
      2. Check firewall: sudo ufw status
      3. Check fail2ban: sudo fail2ban-client status sshd
      4. Check if your IP is banned: sudo fail2ban-client get sshd banned
      5. View auth logs: sudo tail -50 /var/log/auth.log

      Locked out:
      - Access via console (VM/physical access)
      - Check fail2ban bans: sudo fail2ban-client get sshd banned
      - Unban yourself: sudo fail2ban-client set sshd unbanip <YOUR_IP>

      Configuration files:
      - SSH: /etc/ssh/sshd_config
      - Fail2ban: /etc/fail2ban/jail.local
      - Fail2ban log: /var/log/fail2ban.log
      - Auth log: /var/log/auth.log

      ═══════════════════════════════════════════════════════════════

      SSH server is now ready for remote connections!
  tags:
    - openssh
    - ssh
    - security
