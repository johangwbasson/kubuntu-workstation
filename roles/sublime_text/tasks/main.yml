---
# tasks file for sublime_text

- name: Install dependencies for Sublime Text installation
  ansible.builtin.apt:
    name:
      - wget
      - gpg
      - apt-transport-https
    state: present
    update_cache: true
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - dependencies

- name: Check if Sublime Text GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ sublime_gpg_keyring_path }}"
  register: sublime_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Remove corrupted Sublime Text GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ sublime_gpg_keyring_path }}"
    state: absent
  when: sublime_keyring_check.rc != 0
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Download Sublime HQ GPG key
  ansible.builtin.get_url:
    url: "{{ sublime_gpg_key_url }}"
    dest: /tmp/sublime-gpg-key.asc
    mode: '0644'
    checksum: "{{ sublime_gpg_key_checksum }}"
  when: sublime_keyring_check.rc != 0
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Convert Sublime HQ GPG key to keyring format
  ansible.builtin.command:
    cmd: gpg --dearmor --output "{{ sublime_gpg_keyring_path }}" /tmp/sublime-gpg-key.asc
    creates: "{{ sublime_gpg_keyring_path }}"
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Set correct permissions on Sublime Text GPG keyring
  ansible.builtin.file:
    path: "{{ sublime_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Add Sublime Text repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by={{ sublime_gpg_keyring_path }}] {{ sublime_repo_url }} apt/stable/"
    state: present
    filename: sublime-text
    update_cache: true
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor

- name: Install Sublime Text
  ansible.builtin.apt:
    name: sublime-text
    state: "{{ sublime_package_state }}"
    update_cache: true
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor

- name: Ensure Sublime Text Packages/User directory exists
  ansible.builtin.file:
    path: "{{ sublime_config_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ username }}"
    group: "{{ username }}"
  become: true
  become_user: "{{ username }}"
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - configuration

- name: Check if Sublime Text preferences exist
  ansible.builtin.stat:
    path: "{{ sublime_config_dir }}/Preferences.sublime-settings"
  register: sublime_preferences
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - configuration

- name: Copy Preferences configuration
  ansible.builtin.copy:
    src: "Preferences.sublime-settings"
    dest: "{{ sublime_config_dir }}/Preferences.sublime-settings"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  become: true
  become_user: "{{ username }}"
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - configuration

- name: Copy Package Control configuration
  ansible.builtin.copy:
    src: "Package Control.sublime-settings"
    dest: "{{ sublime_config_dir }}/Package Control.sublime-settings"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  become: true
  become_user: "{{ username }}"
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - configuration
