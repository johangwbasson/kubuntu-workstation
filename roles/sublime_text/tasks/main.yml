---
# tasks file for sublime_text

- name: Install dependencies for Sublime Text installation
  ansible.builtin.apt:
    name:
      - wget
      - gpg
      - apt-transport-https
    state: present
    update_cache: true
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - dependencies

- name: Check if Sublime Text GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ sublime_gpg_keyring_path }}"
  register: sublime_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Remove corrupted Sublime Text GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ sublime_gpg_keyring_path }}"
    state: absent
  when: sublime_keyring_check.rc != 0
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Download and convert Sublime HQ GPG key
  ansible.builtin.shell: |
    set -o pipefail
    curl -fsSL "{{ sublime_gpg_key_url }}" | gpg --dearmor -o "{{ sublime_gpg_keyring_path }}"
  args:
    executable: /bin/bash
    creates: "{{ sublime_gpg_keyring_path }}"
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Set correct permissions on Sublime Text GPG keyring
  ansible.builtin.file:
    path: "{{ sublime_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
    - security

- name: Remove malformed Sublime Text repository file if it exists
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/sublime-text.list
    state: absent
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor

- name: Add Sublime Text repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by={{ sublime_gpg_keyring_path }}] {{ sublime_repo_url }} apt/stable/"
    state: present
    filename: sublime-text
    update_cache: true
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor

- name: Install Sublime Text
  ansible.builtin.apt:
    name: sublime-text
    state: "{{ sublime_package_state }}"
    update_cache: true
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor

- name: Display Sublime Text installation info
  ansible.builtin.debug:
    msg: |
      Sublime Text has been installed successfully!

      Installed components:
      - Sublime Text (subl)
      - Package Control (built-in)
      - Command palette
      - Multiple cursors
      - Goto Anything

      Useful commands:
      - subl                     : Launch Sublime Text
      - subl <file>              : Open file in Sublime Text
      - subl <folder>            : Open folder in Sublime Text
      - subl -n                  : Open new window
      - subl -a <file>           : Add file to current window

      Keyboard shortcuts:
      - Ctrl+Shift+P            : Command palette
      - Ctrl+P                  : Goto Anything (quick file open)
      - Ctrl+R                  : Goto Symbol
      - Ctrl+G                  : Goto Line
      - Ctrl+D                  : Select next occurrence
      - Ctrl+Shift+D            : Duplicate line
      - Ctrl+Shift+K            : Delete line
      - Ctrl+K, Ctrl+B          : Toggle sidebar
      - Ctrl+`                  : Show console

      Install Package Control packages:
      1. Press Ctrl+Shift+P
      2. Type "Install Package"
      3. Search and install packages

      Popular packages:
      - LSP (Language Server Protocol support)
      - Terminus (integrated terminal)
      - GitGutter (Git diff markers)
      - BracketHighlighter
      - SideBarEnhancements
      - SublimeLinter
      - DocBlockr
      - Emmet
      - Color Highlighter

      Configuration files location:
      ~/.config/sublime-text/Packages/User/

      Set as default editor:
      xdg-mime default sublime_text.desktop text/plain

      Sublime Text will receive automatic updates through APT!

      Note: Sublime Text is free to use but requires a license for continued use.
      You can evaluate it without time limit, but a license supports development.
  tags:
    - sublime-text
    - sublime
    - packages
    - development
    - editor
