---
# tasks file for terraform

- name: Install dependencies for Terraform installation
  ansible.builtin.apt:
    name:
      - wget
      - gpg
      - coreutils
      - lsb-release
    state: present
    update_cache: true
  tags:
    - terraform
    - infrastructure
    - packages
    - dependencies

- name: Check if Terraform GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ terraform_gpg_keyring_path }}"
  register: terraform_keyring_check
  changed_when: false
  failed_when: false
  when: not ansible_check_mode
  tags:
    - terraform
    - infrastructure
    - packages
    - security

- name: Remove corrupted Terraform GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ terraform_gpg_keyring_path }}"
    state: absent
  when:
    - terraform_keyring_check.rc is defined
    - terraform_keyring_check.rc != 0
  tags:
    - terraform
    - infrastructure
    - packages
    - security

- name: Download HashiCorp GPG key
  ansible.builtin.get_url:
    url: "{{ terraform_gpg_key_url }}"
    dest: /tmp/hashicorp-gpg-key.asc
    mode: '0644'
  when: not ansible_check_mode
  tags:
    - terraform
    - infrastructure
    - packages
    - security

- name: Convert and install HashiCorp GPG key to keyring
  ansible.builtin.shell: |
    set -o pipefail
    cat /tmp/hashicorp-gpg-key.asc | gpg --dearmor --output {{ terraform_gpg_keyring_path }}
  args:
    creates: "{{ terraform_gpg_keyring_path }}"
    executable: /bin/bash
  when: not ansible_check_mode
  tags:
    - terraform
    - infrastructure
    - packages
    - security

- name: Set proper permissions on HashiCorp keyring
  ansible.builtin.file:
    path: "{{ terraform_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  when: not ansible_check_mode
  tags:
    - terraform
    - infrastructure
    - packages
    - security

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/hashicorp-gpg-key.asc
    state: absent
  tags:
    - terraform
    - infrastructure
    - packages
    - cleanup

- name: Get Ubuntu codename
  ansible.builtin.command: lsb_release -cs
  register: ubuntu_codename
  changed_when: false
  tags:
    - terraform
    - infrastructure
    - packages

- name: Add HashiCorp repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ terraform_gpg_keyring_path }}] {{ terraform_repo_url }} {{ ubuntu_codename.stdout }} main"
    state: present
    filename: hashicorp
    update_cache: true
  tags:
    - terraform
    - infrastructure
    - packages

- name: Install Terraform
  ansible.builtin.apt:
    name: terraform
    state: "{{ terraform_package_state }}"
    update_cache: true
  tags:
    - terraform
    - infrastructure
    - packages

- name: Ensure bash completion directory exists
  ansible.builtin.file:
    path: /etc/bash_completion.d
    state: directory
    mode: '0755'
  tags:
    - terraform
    - infrastructure
    - completion

- name: Check if Terraform bash completion is installed
  ansible.builtin.shell: |
    grep -q 'complete -C.*terraform' "{{ terraform_user_home }}/.bashrc"
  register: terraform_bash_completion_exists
  changed_when: false
  failed_when: false
  tags:
    - terraform
    - infrastructure
    - completion

- name: Enable Terraform bash completion
  ansible.builtin.command: terraform -install-autocomplete
  when:
    - terraform_bash_completion_exists.rc is defined
    - terraform_bash_completion_exists.rc != 0
  changed_when: true
  failed_when: false
  tags:
    - terraform
    - infrastructure
    - completion

- name: Check if Fish shell is installed
  ansible.builtin.command: which fish
  register: fish_installed
  changed_when: false
  failed_when: false
  tags:
    - terraform
    - infrastructure
    - completion

- name: Ensure Fish completions directory exists
  ansible.builtin.file:
    path: "{{ terraform_user_home }}/.config/fish/completions"
    state: directory
    owner: "{{ terraform_user }}"
    group: "{{ terraform_user }}"
    mode: '0755'
  when:
    - fish_installed.rc is defined
    - fish_installed.rc == 0
  tags:
    - terraform
    - infrastructure
    - completion

- name: Check if Terraform Fish completion is installed
  become: true
  become_user: "{{ terraform_user }}"
  ansible.builtin.shell: |
    grep -q 'complete -c terraform' "{{ terraform_user_home }}/.config/fish/config.fish" 2>/dev/null
  when:
    - fish_installed.rc is defined
    - fish_installed.rc == 0
  register: terraform_fish_completion_exists
  changed_when: false
  failed_when: false
  tags:
    - terraform
    - infrastructure
    - completion

- name: Generate Terraform Fish completion
  become: true
  become_user: "{{ terraform_user }}"
  ansible.builtin.command: terraform -install-autocomplete
  when:
    - fish_installed.rc is defined
    - fish_installed.rc == 0
    - terraform_fish_completion_exists.rc is defined
    - terraform_fish_completion_exists.rc != 0
  changed_when: true
  failed_when: false
  tags:
    - terraform
    - infrastructure
    - completion

- name: Create Terraform aliases for bash
  ansible.builtin.lineinfile:
    path: "{{ terraform_user_home }}/.bashrc"
    line: "{{ item }}"
    create: true
    owner: "{{ terraform_user }}"
    group: "{{ terraform_user }}"
    mode: '0644'
  loop:
    - "# Terraform aliases"
    - "alias tf='terraform'"
  tags:
    - terraform
    - infrastructure
    - aliases

- name: Check if Terraform abbreviation exists in Fish
  become: true
  become_user: "{{ terraform_user }}"
  ansible.builtin.shell: |
    set -o pipefail
    fish -c "abbr --show | grep -q '^abbr -a -g -- tf terraform$'"
  args:
    executable: /bin/bash
  when:
    - fish_installed.rc is defined
    - fish_installed.rc == 0
  register: terraform_abbr_exists
  changed_when: false
  failed_when: false
  tags:
    - terraform
    - infrastructure
    - aliases

- name: Create Terraform abbreviations for Fish
  become: true
  become_user: "{{ terraform_user }}"
  ansible.builtin.command: fish -c "abbr --add --global tf terraform"
  when:
    - fish_installed.rc is defined
    - fish_installed.rc == 0
    - terraform_abbr_exists.rc is defined
    - terraform_abbr_exists.rc != 0
  changed_when: true
  tags:
    - terraform
    - infrastructure
    - aliases
