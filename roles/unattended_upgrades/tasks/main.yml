---
# tasks file for unattended_upgrades

- name: Install unattended-upgrades package
  ansible.builtin.apt:
    name:
      - unattended-upgrades
      - apt-listchanges
    state: present
    update_cache: true
    cache_valid_time: 3600
  tags:
    - unattended_upgrades
    - packages
    - security

- name: Ensure update-notifier-common is installed (for update checking)
  ansible.builtin.apt:
    name: update-notifier-common
    state: present
  tags:
    - unattended_upgrades
    - packages

- name: Configure automatic updates frequency (20auto-upgrades)
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: '0644'
  tags:
    - unattended_upgrades
    - configuration
    - security

- name: Configure unattended-upgrades settings (50unattended-upgrades)
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'
  tags:
    - unattended_upgrades
    - configuration
    - security

- name: Ensure apt daily service is enabled
  ansible.builtin.systemd:
    name: apt-daily.timer
    enabled: "{{ unattended_upgrades_enabled }}"
    state: "{{ 'started' if unattended_upgrades_enabled else 'stopped' }}"
  tags:
    - unattended_upgrades
    - services

- name: Ensure apt daily upgrade service is enabled
  ansible.builtin.systemd:
    name: apt-daily-upgrade.timer
    enabled: "{{ unattended_upgrades_enabled }}"
    state: "{{ 'started' if unattended_upgrades_enabled else 'stopped' }}"
  tags:
    - unattended_upgrades
    - services

- name: Get system codename for display
  ansible.builtin.command: lsb_release -cs
  register: system_codename
  changed_when: false
  tags:
    - unattended_upgrades

- name: Check if mail transport is configured (for email notifications)
  ansible.builtin.stat:
    path: /usr/sbin/sendmail
  register: sendmail_installed
  when: unattended_upgrades_mail_enabled
  tags:
    - unattended_upgrades
    - mail
