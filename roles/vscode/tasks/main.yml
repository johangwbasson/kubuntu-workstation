---
# tasks file for vscode

- name: Install dependencies for VS Code installation
  ansible.builtin.apt:
    name:
      - wget
      - gpg
      - apt-transport-https
    state: present
    update_cache: true
  tags:
    - vscode
    - packages
    - development
    - editor
    - dependencies

- name: Remove conflicting VS Code repository file (DEB822 format)
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/vscode.sources
    state: absent
  tags:
    - vscode
    - packages
    - development
    - editor

- name: Remove old Microsoft GPG keyring if it conflicts
  ansible.builtin.file:
    path: /usr/share/keyrings/microsoft.gpg
    state: absent
  tags:
    - vscode
    - packages
    - development
    - editor
    - cleanup

- name: Check if VS Code GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ vscode_gpg_keyring_path }}"
  register: vscode_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - vscode
    - packages
    - development
    - editor
    - security

- name: Remove corrupted VS Code GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ vscode_gpg_keyring_path }}"
    state: absent
  when: vscode_keyring_check.rc != 0
  tags:
    - vscode
    - packages
    - development
    - editor
    - security

- name: Download Microsoft GPG key
  ansible.builtin.get_url:
    url: "{{ vscode_gpg_key_url }}"
    dest: /tmp/microsoft-gpg-key.asc
    mode: '0644'
  tags:
    - vscode
    - packages
    - development
    - editor
    - security

- name: Convert and install Microsoft GPG key to keyring
  ansible.builtin.command:
    cmd: gpg --dearmor --output "{{ vscode_gpg_keyring_path }}" /tmp/microsoft-gpg-key.asc
    creates: "{{ vscode_gpg_keyring_path }}"
  tags:
    - vscode
    - packages
    - development
    - editor
    - security

- name: Set proper permissions on Microsoft keyring
  ansible.builtin.file:
    path: "{{ vscode_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  tags:
    - vscode
    - packages
    - development
    - editor
    - security

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/microsoft-gpg-key.asc
    state: absent
  tags:
    - vscode
    - packages
    - development
    - editor
    - cleanup

- name: Add VS Code repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by={{ vscode_gpg_keyring_path }}] {{ vscode_repo_url }} stable main"
    state: present
    filename: vscode
    update_cache: true
  tags:
    - vscode
    - packages
    - development
    - editor

- name: Install Visual Studio Code
  ansible.builtin.apt:
    name: code
    state: "{{ vscode_package_state }}"
    update_cache: true
  tags:
    - vscode
    - packages
    - development
    - editor

- name: Get list of installed VS Code extensions
  become: true
  become_user: "{{ vscode_user }}"
  ansible.builtin.command: code --list-extensions
  register: vscode_installed_extensions
  changed_when: false
  failed_when: false
  tags:
    - vscode
    - extensions

- name: Install VS Code extensions
  become: true
  become_user: "{{ vscode_user }}"
  ansible.builtin.command:
    cmd: code --install-extension "{{ item }}" --force
  loop: "{{ vscode_extensions }}"
  when:
    - vscode_install_recommended or item in ['rooveterinaryinc.roo-cline', 'k--kato.intellij-idea-keybindings', 'vscjava.vscode-java-pack']
    - item not in vscode_installed_extensions.stdout_lines
  register: vscode_extension_install
  changed_when: "'was successfully installed' in vscode_extension_install.stdout or 'is already installed' not in vscode_extension_install.stdout"
  tags:
    - vscode
    - extensions

- name: Display VS Code installation info
  ansible.builtin.debug:
    msg: |
      Visual Studio Code has been installed successfully!

      Installed components:
      - VS Code (code)
      - Integrated terminal
      - Git integration
      - Extension marketplace

      Extensions automatically installed:
      - Roo Code (rooveterinaryinc.roo-cline) - AI coding assistant
      - IntelliJ IDEA Keybindings (k--kato.intellij-idea-keybindings)
      - Extension Pack for Java (vscjava.vscode-java-pack)
      {% if vscode_install_recommended %}
      - GitLens (eamodio.gitlens) - Enhanced Git integration
      - Terraform (hashicorp.terraform)
      - Docker (ms-azuretools.vscode-docker)
      - Kubernetes Tools (ms-kubernetes-tools.vscode-kubernetes-tools)
      {% endif %}

      Useful commands:
      - code                      : Launch VS Code
      - code <file>               : Open file in VS Code
      - code <folder>             : Open folder in VS Code
      - code --install-extension  : Install extension
      - code --list-extensions    : List installed extensions
      - code --version            : Show VS Code version

      Recommended first steps:
      1. Launch VS Code: code
      2. Browse extensions: Ctrl+Shift+X
      3. Open settings: Ctrl+,
      4. Configure Roo Code AI assistant
      5. Java Development Kit detected automatically via Extension Pack

      Additional useful extensions:
      - ms-python.python          : Python support
      - ms-vscode.cpptools        : C/C++ support
      - GitHub.copilot            : GitHub Copilot AI
      - vscodevim.vim             : Vim keybindings

      Manage extensions:
      code --install-extension <extension-id>
      code --uninstall-extension <extension-id>
      code --list-extensions

      VS Code will receive automatic updates through APT!
  tags:
    - vscode
    - packages
    - development
    - editor
