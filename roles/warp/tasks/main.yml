---
# tasks file for warp

- name: Install dependencies for Warp terminal
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - gnupg
      - wget
    state: present
    update_cache: true
  tags:
    - warp
    - terminal
    - packages
    - dependencies

- name: Check if Warp GPG keyring exists and is valid
  ansible.builtin.command: gpg --list-keys --keyring "{{ warp_gpg_keyring_path }}"
  register: warp_keyring_check
  changed_when: false
  failed_when: false
  tags:
    - warp
    - terminal
    - packages
    - security

- name: Remove corrupted Warp GPG keyring if invalid
  ansible.builtin.file:
    path: "{{ warp_gpg_keyring_path }}"
    state: absent
  when: warp_keyring_check.rc != 0
  tags:
    - warp
    - terminal
    - packages
    - security

- name: Download Warp GPG key
  ansible.builtin.get_url:
    url: "{{ warp_gpg_key_url }}"
    dest: /tmp/warp-gpg-key.asc
    mode: '0644'
  tags:
    - warp
    - terminal
    - packages
    - security

- name: Convert and install Warp GPG key to keyring
  ansible.builtin.command:
    cmd: gpg --dearmor --output "{{ warp_gpg_keyring_path }}" /tmp/warp-gpg-key.asc
    creates: "{{ warp_gpg_keyring_path }}"
  tags:
    - warp
    - terminal
    - packages
    - security

- name: Set proper permissions on Warp keyring
  ansible.builtin.file:
    path: "{{ warp_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  tags:
    - warp
    - terminal
    - packages
    - security

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/warp-gpg-key.asc
    state: absent
  tags:
    - warp
    - terminal
    - packages
    - cleanup

- name: Add Warp terminal repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by={{ warp_gpg_keyring_path }}] {{ warp_repo_url }} stable main"
    state: present
    filename: warp-terminal
    update_cache: true
  tags:
    - warp
    - terminal
    - packages

- name: Install Warp terminal
  ansible.builtin.apt:
    name: "{{ warp_package_name }}"
    state: "{{ warp_package_state }}"
    update_cache: true
  tags:
    - warp
    - terminal
    - packages

- name: Get Warp version
  ansible.builtin.command: warp-terminal --version
  register: warp_version_output
  changed_when: false
  failed_when: false
  tags:
    - warp
    - terminal

- name: Display Warp terminal installation info
  ansible.builtin.debug:
    msg: |
      Warp Terminal has been installed successfully!

      Installation details:
      - Binary location: /usr/bin/warp-terminal
      - Version: {{ warp_version_output.stdout | default('N/A') }}
      - Desktop entry: /usr/share/applications/warp-terminal.desktop
      - Repository: {{ warp_repo_url }}
      - Managed by apt package manager

      Features:
      - GPU-accelerated rendering (Rust + WebGPU)
      - AI-powered command suggestions (Warp AI)
      - Block-based output (like a notebook)
      - Backward search with ⌘R / Ctrl+R
      - Command palette (⌘P / Ctrl+P)
      - Collaborative terminal sessions
      - Built-in autocomplete
      - Custom themes and prompts
      - Cloud sync for settings
      - Split panes and tabs
      - SSH workflow support

      Getting started:
      1. Launch from application menu: Search for "Warp"
      2. Or run from terminal: warp-terminal
      3. Sign up for Warp account (optional but recommended for AI features)
      4. Configure your preferences in Settings

      First-time setup:
      1. Launch Warp from the application menu
      2. Choose to sign in or continue without account
      3. Select your default shell (bash/zsh/fish)
      4. Customize appearance and theme
      5. Try Warp AI with #<command description>

      Key features and shortcuts:

      Block-based terminal:
      - Each command and output is a "block"
      - Click to focus a block
      - Copy entire output with one click
      - Share blocks as links (if using Warp account)

      Warp AI (requires account):
      - Type # followed by natural language
      - Example: #find all python files modified today
      - Example: #git commit with message "fix bug"
      - AI suggests the actual command
      - Press Enter to accept or edit

      Command palette (Ctrl+P or ⌘P):
      - Quick access to all Warp features
      - Search for commands, workflows, settings
      - Create custom workflows

      Workflows:
      - Save frequently used commands as workflows
      - Parametrize with variables
      - Share with team (if using Warp account)

      Keyboard shortcuts:
      - Ctrl+P          : Open command palette
      - Ctrl+R          : Backward search through history
      - Ctrl+Shift+R    : Forward search
      - Ctrl+D          : Close terminal / split
      - Ctrl+Shift+T    : New tab
      - Ctrl+Shift+D    : Split pane vertically
      - Ctrl+Shift+F    : Find in terminal
      - Ctrl+L          : Clear screen
      - Ctrl+K          : Clear scrollback
      - Ctrl+,          : Open settings

      Split panes:
      - Ctrl+Shift+D    : Split vertically
      - Ctrl+Shift+H    : Split horizontally
      - Ctrl+W          : Close current pane
      - Ctrl+[hjkl]     : Navigate between panes

      Tabs:
      - Ctrl+Shift+T    : New tab
      - Ctrl+Tab        : Next tab
      - Ctrl+Shift+Tab  : Previous tab
      - Ctrl+W          : Close tab

      Autocomplete:
      - Warp provides intelligent autocomplete
      - Learns from your command history
      - Suggests flags, paths, git branches
      - Press Tab to accept suggestions

      Themes and customization:
      - Settings → Appearance → Theme
      - Choose from built-in themes or create custom
      - Customize fonts, colors, opacity
      - Settings sync across devices (with account)

      Integration with shells:

      Bash:
      - Works with default bash configuration
      - Supports .bashrc customizations
      - Compatible with bash completions

      Zsh (with oh-my-zsh):
      - Full support for oh-my-zsh
      - Powerlevel10k theme works great
      - All zsh plugins compatible
      - Maintains oh-my-zsh aliases

      Fish:
      - Native fish shell support
      - Fish completions work seamlessly
      - Tide prompt compatible

      SSH workflow:
      - SSH into servers directly
      - Save SSH connections
      - Port forwarding support
      - Agent forwarding supported

      Advanced features:

      Collaboration (requires Warp Teams):
      - Share terminal sessions with team
      - Multiple users in same terminal
      - See each other's cursor
      - Real-time collaboration

      Cloud features (requires account):
      - Sync settings across machines
      - Cloud command history
      - Shared workflows with team
      - Block sharing via links

      Performance:
      - GPU-accelerated rendering
      - Fast scrollback (millions of lines)
      - Instant search in output
      - Low latency input

      Tips for Java/Kotlin developers:
      - Use workflows for common gradle/maven commands
      - Save multi-step build processes
      - AI can generate complex git commands
      - Block output makes reading stack traces easier
      - Share error logs via block links
      - SSH to development servers with saved configs

      Create custom workflows:
      1. Run a command successfully
      2. Click the ⚡ icon in the block
      3. Save as workflow with parameters
      4. Access via command palette (Ctrl+P)

      Example workflows for development:
      - Git commit workflow: git add . && git commit -m "{{message}}"
      - Maven build: mvn clean install -DskipTests={{skip}}
      - Docker compose: docker-compose -f {{file}} up -d
      - K8s deploy: kubectl apply -f {{manifest}} -n {{namespace}}

      Privacy and data:
      - Command history stored locally by default
      - Cloud sync is opt-in (requires account)
      - AI features send commands to Warp servers
      - Can use without account (limited features)
      - Review privacy settings in: Settings → Privacy

      Comparison with other terminals:
      - vs Traditional terminals: Block UI, AI features, faster
      - vs iTerm2/Alacritty: AI suggestions, workflows, collaboration
      - vs Tmux: Built-in panes, no configuration needed
      - Plays well with existing tools (zsh, tmux, etc.)

      Documentation: https://docs.warp.dev/
      Community: https://github.com/warpdotdev/Warp
      Support: https://warp.dev/support

      Update Warp:
      - Automatic via apt: sudo apt update && sudo apt upgrade warp-terminal
      - Or use Warp's built-in updater: Settings → About → Check for updates

      Note: Warp requires a GPU and X11/Wayland. Works best with modern GPUs.
      For servers/headless systems, use traditional terminals.
  tags:
    - warp
    - terminal
