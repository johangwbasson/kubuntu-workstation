---
# tasks file for warp

- name: Remove old Warp GPG keys (cleanup from previous installations)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/trusted.gpg.d/warpdotdev.gpg
    - /usr/share/keyrings/warpdotdev.gpg
    - /usr/share/keyrings/warp-terminal.gpg
  tags:
    - warp
    - terminal
    - packages
    - cleanup

- name: Remove old Warp repository configurations
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/warp.list
    - /etc/apt/sources.list.d/warpdotdev.list
    - /etc/apt/sources.list.d/warp-terminal.list
    - /etc/apt/sources.list.d/warp-terminal.sources
  tags:
    - warp
    - terminal
    - packages
    - cleanup

- name: Ensure /etc/apt/keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags:
    - warp
    - terminal
    - packages

- name: Download Warp GPG key
  ansible.builtin.get_url:
    url: "{{ warp_gpg_key_url }}"
    dest: /tmp/warp.asc
    mode: '0644'
  when: not ansible_check_mode
  tags:
    - warp
    - terminal
    - packages

- name: Convert and install Warp GPG key to keyring
  ansible.builtin.shell:
    cmd: gpg --dearmor < /tmp/warp.asc > {{ warp_gpg_keyring_path }}
    creates: "{{ warp_gpg_keyring_path }}"
  when: not ansible_check_mode
  tags:
    - warp
    - terminal
    - packages

- name: Set correct permissions on Warp GPG keyring
  ansible.builtin.file:
    path: "{{ warp_gpg_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
  when: not ansible_check_mode
  tags:
    - warp
    - terminal
    - packages

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/warp.asc
    state: absent
  tags:
    - warp
    - terminal
    - packages
    - cleanup

- name: Add Warp official APT repository
  ansible.builtin.apt_repository:
    repo: "{{ warp_repository }}"
    state: present
    filename: warpdotdev
    update_cache: true
  tags:
    - warp
    - terminal
    - packages

- name: Install Warp terminal from official repository
  ansible.builtin.apt:
    name: "{{ warp_package_name }}"
    state: present
    update_cache: true
  tags:
    - warp
    - terminal
    - packages

- name: Get Warp version
  ansible.builtin.command: warp-terminal --version
  register: warp_version_output
  changed_when: false
  failed_when: false
  tags:
    - warp
    - terminal
