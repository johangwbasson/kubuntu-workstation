---
# tasks file for zsh

- name: Install zsh package
  ansible.builtin.apt:
    name: zsh
    state: present
    update_cache: true
    cache_valid_time: 3600
  tags:
    - zsh
    - packages
    - shell

- name: Check if Oh My Zsh is already installed
  ansible.builtin.stat:
    path: "{{ ohmyzsh_dir }}"
  register: ohmyzsh_installed
  tags:
    - zsh
    - ohmyzsh

- name: Download Oh My Zsh installer
  ansible.builtin.get_url:
    url: "{{ ohmyzsh_install_url }}"
    dest: /tmp/ohmyzsh-install.sh
    mode: '0755'
    force: true
  when: not ohmyzsh_installed.stat.exists
  tags:
    - zsh
    - ohmyzsh
    - download
  # Note: Oh My Zsh installer is downloaded from GitHub. Security relies on HTTPS.

- name: Install Oh My Zsh
  become: true
  become_user: "{{ zsh_user }}"
  ansible.builtin.command:
    cmd: sh /tmp/ohmyzsh-install.sh --unattended
  environment:
    HOME: "{{ zsh_user_home }}"
  when: not ohmyzsh_installed.stat.exists
  changed_when: true  # Task only runs when Oh My Zsh directory doesn't exist
  tags:
    - zsh
    - ohmyzsh

- name: Ensure Oh My Zsh custom themes directory exists
  ansible.builtin.file:
    path: "{{ ohmyzsh_dir }}/custom/themes"
    state: directory
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    mode: '0755'
  tags:
    - zsh
    - ohmyzsh
    - themes

- name: Clone Powerlevel10k theme
  become: true
  become_user: "{{ zsh_user }}"
  ansible.builtin.git:
    repo: "{{ p10k_repo }}"
    dest: "{{ p10k_dir }}"
    version: "{{ p10k_version }}"
    update: false
  tags:
    - zsh
    - ohmyzsh
    - themes
    - powerlevel10k

- name: Install dependencies for SDKMAN
  ansible.builtin.apt:
    name:
      - curl
      - unzip
      - zip
    state: present
  tags:
    - zsh
    - shell
    - sdkman
    - dependencies

- name: Download SDKMAN installer
  ansible.builtin.get_url:
    url: "https://get.sdkman.io?rcupdate=false"
    dest: /tmp/sdkman-install.sh
    mode: '0755'
    force: true
  tags:
    - zsh
    - shell
    - sdkman
    - development

- name: Install SDKMAN
  become: true
  become_user: "{{ zsh_user }}"
  ansible.builtin.command:
    cmd: bash /tmp/sdkman-install.sh
    creates: "{{ zsh_user_home }}/.sdkman"
  environment:
    HOME: "{{ zsh_user_home }}"
  tags:
    - zsh
    - shell
    - sdkman
    - development

- name: Check if .zshrc exists and is not a symlink
  ansible.builtin.stat:
    path: "{{ zsh_user_home }}/.zshrc"
  register: zshrc_stat
  tags:
    - zsh
    - configuration

- name: Backup existing .zshrc if it exists and is not a symlink
  ansible.builtin.copy:
    src: "{{ zsh_user_home }}/.zshrc"
    dest: "{{ zsh_user_home }}/.zshrc.backup.{{ ansible_date_time.epoch }}"
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    mode: '0644'
    remote_src: true
  when:
    - zshrc_stat.stat.exists
    - not zshrc_stat.stat.islnk
  tags:
    - zsh
    - configuration
    - backup

- name: Remove .zshrc if it exists and is not a symlink
  ansible.builtin.file:
    path: "{{ zsh_user_home }}/.zshrc"
    state: absent
  when:
    - zshrc_stat.stat.exists
    - not zshrc_stat.stat.islnk
  tags:
    - zsh
    - configuration

- name: Create symlink from .zshrc to repository file
  ansible.builtin.file:
    src: "{{ zshrc_source_file }}"
    dest: "{{ zsh_user_home }}/.zshrc"
    owner: "{{ zsh_user }}"
    group: "{{ zsh_user }}"
    state: link
    force: true
  tags:
    - zsh
    - configuration

- name: Check current shell for user
  ansible.builtin.command: "getent passwd {{ zsh_user }}"
  register: user_shell_info
  changed_when: false
  tags:
    - zsh
    - shell

- name: Set zsh as default shell for user
  ansible.builtin.user:
    name: "{{ zsh_user }}"
    shell: /usr/bin/zsh
  when:
    - zsh_set_as_default_shell
    - "'/usr/bin/zsh' not in user_shell_info.stdout"
  tags:
    - zsh
    - shell
